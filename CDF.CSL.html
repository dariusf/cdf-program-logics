
<!DOCTYPE html>
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module CSL</title>
<meta name="description" content="Documentation of Coq module CSL" />
<link href="coq2html.css" rel="stylesheet" type="text/css" />
</head>

<body>
<h1 class="title">Module CSL</h1>
<div class="coq">
<div class="doc">Concurrent separation logic. </div>
<br/>
<span class="kwd">From</span> <span class="id">Coq</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.ZArith.html">ZArith</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.micromega.Lia.html">Lia</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Bool.Bool.html">Bool</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Strings.String.html">String</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Lists.List.html">List</a></span>.<br/>
<span class="kwd">From</span> <span class="id">Coq</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Logic.FunctionalExtensionality.html">FunctionalExtensionality</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Logic.PropExtensionality.html">PropExtensionality</a></span>.<br/>
<span class="kwd">From</span> <span class="id">CDF</span> <span class="kwd">Require</span> <span class="kwd">Import</span> <span class="id"><a href="CDF.Sequences.html">Sequences</a></span> <span class="id"><a href="CDF.Separation.html">Separation</a></span>.<br/>
<br/>
<span class="id">Local</span> <span class="kwd">Open</span> <span class="kwd">Scope</span> <span class="id">Z_scope</span>.<br/>
<br/>
<h1> 1. A language with pointers and concurrency </h1>
<br/>
<div class="doc">Here is a variant of the PTR language (from the course on separation logic)
    with concurrency (the PAR and ATOMIC constructs).
    Like PTR, it's an ML-like language with immutable variables and
    references to mutable memory locations, represented using higher-order
    abstract syntax. </div>
<br/>
<span class="kwd">Inductive</span> <span class="id"><a name="com">com</a></span>: <span class="kwd">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id"><a name="PURE">PURE</a></span> (<span class="id">x</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Numbers.BinNums.html#Z">Z</a></span>)                      <span class="docright">(* command without effects  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="LET">LET</a></span> (<span class="id">c</span>: <span class="id">com</span>) (<span class="id">f</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Numbers.BinNums.html#Z">Z</a></span> -&gt; <span class="id">com</span>)       <span class="docright">(* sequencing of commands  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="IFTHENELSE">IFTHENELSE</a></span> (<span class="id">b</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Numbers.BinNums.html#Z">Z</a></span>) (<span class="id">c1</span> <span class="id">c2</span>: <span class="id">com</span>    <span class="docright">(* conditional  *)</span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="REPEAT">REPEAT</a></span> (<span class="id">c</span>: <span class="id">com</span>)                  <span class="docright">(* iterate <span class="bracket"><span class="id">c</span></span> until it returns not 0  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="PAR">PAR</a></span> (<span class="id">c1</span> <span class="id">c2</span>: <span class="id">com</span>)                 <span class="docright">(* run <span class="bracket"><span class="id">c1</span></span> and <span class="bracket"><span class="id">c2</span></span> in parallel  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="ATOMIC">ATOMIC</a></span> (<span class="id">c</span>: <span class="id">com</span>)                  <span class="docright">(* run <span class="bracket"><span class="id">c</span></span> as one atomic step  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="ALLOC">ALLOC</a></span> (<span class="id">sz</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>)                  <span class="docright">(* allocate <span class="bracket"><span class="id">sz</span></span> words of storage  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="GET">GET</a></span> (<span class="id">l</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Numbers.BinNums.html#Z">Z</a></span>)                       <span class="docright">(* dereference a pointer  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="SET">SET</a></span> (<span class="id">l</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Numbers.BinNums.html#Z">Z</a></span>) (<span class="id">v</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Numbers.BinNums.html#Z">Z</a></span>)                <span class="docright">(* assign through a pointer  *)</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="FREE">FREE</a></span> (<span class="id">l</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Numbers.BinNums.html#Z">Z</a></span>).                     <span class="docright">(* free one word of storage  *)</span><br/>
<br/>
<div class="doc">Some derived forms. </div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="SKIP">SKIP</a></span>: <span class="id"><a href="CDF.CSL.html#com">com</a></span> := <span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> 0.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="SEQ">SEQ</a></span> (<span class="id">c1</span> <span class="id">c2</span>: <span class="id"><a href="CDF.CSL.html#com">com</a></span>) := <span class="id"><a href="CDF.CSL.html#LET">LET</a></span> <span class="id">c1</span> (<span class="kwd">fun</span> _ =&gt; <span class="id">c2</span>).<br/>
<br/>
<div class="doc">Locations that can be read / written right now. </div>
<br/>
<span class="kwd">Fixpoint</span> <span class="id"><a name="immacc">immacc</a></span> (<span class="id">l</span>: <span class="id"><a href="CDF.Separation.html#addr">addr</a></span>) (<span class="id">c</span>: <span class="id"><a href="CDF.CSL.html#com">com</a></span>) : <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">c</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="CDF.CSL.html#LET">LET</a></span> <span class="id">c</span> _ =&gt; <span class="id">immacc</span> <span class="id">l</span> <span class="id">c</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="CDF.CSL.html#PAR">PAR</a></span> <span class="id">c1</span> <span class="id">c2</span> =&gt; <span class="id">immacc</span> <span class="id">l</span> <span class="id">c1</span> \/ <span class="id">immacc</span> <span class="id">l</span> <span class="id">c2</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="CDF.CSL.html#GET">GET</a></span> <span class="id">l'</span> =&gt; <span class="id">l</span> = <span class="id">l'</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="CDF.CSL.html#SET">SET</a></span> <span class="id">l'</span> _ =&gt; <span class="id">l</span> = <span class="id">l'</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="CDF.CSL.html#FREE">FREE</a></span> <span class="id">l'</span> =&gt; <span class="id">l</span> = <span class="id">l'</span><br/>
&nbsp;&nbsp;| _ =&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#False">False</a></span><br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<div class="doc">Reduction semantics. </div>
<br/>
<span class="kwd">Inductive</span> <span class="id"><a name="red">red</a></span>: <span class="id"><a href="CDF.CSL.html#com">com</a></span> * <span class="id"><a href="CDF.Separation.html#heap">heap</a></span> -&gt; <span class="id"><a href="CDF.CSL.html#com">com</a></span> * <span class="id"><a href="CDF.Separation.html#heap">heap</a></span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id"><a name="red_let_done">red_let_done</a></span>: <span class="kwd">forall</span> <span class="id">x</span> <span class="id">f</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">red</span> (<span class="id"><a href="CDF.CSL.html#LET">LET</a></span> (<span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> <span class="id">x</span>) <span class="id">f</span>, <span class="id">h</span>) (<span class="id">f</span> <span class="id">x</span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="red_let_step">red_let_step</a></span>: <span class="kwd">forall</span> <span class="id">c</span> <span class="id">f</span> <span class="id">h</span> <span class="id">c'</span> <span class="id">h'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">red</span> (<span class="id">c</span>, <span class="id">h</span>) (<span class="id">c'</span>, <span class="id">h'</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">red</span> (<span class="id"><a href="CDF.CSL.html#LET">LET</a></span> <span class="id">c</span> <span class="id">f</span>, <span class="id">h</span>) (<span class="id"><a href="CDF.CSL.html#LET">LET</a></span> <span class="id">c'</span> <span class="id">f</span>, <span class="id">h'</span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="red_ifthenelse">red_ifthenelse</a></span>: <span class="kwd">forall</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">red</span> (<span class="id"><a href="CDF.CSL.html#IFTHENELSE">IFTHENELSE</a></span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span>, <span class="id">h</span>) ((<span class="kwd">if</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.eqb">Z.eqb</a></span> <span class="id">b</span> 0 <span class="kwd">then</span> <span class="id">c2</span> <span class="kwd">else</span> <span class="id">c1</span>), <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="red_repeat">red_repeat</a></span>: <span class="kwd">forall</span> <span class="id">c</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">red</span> (<span class="id"><a href="CDF.CSL.html#REPEAT">REPEAT</a></span> <span class="id">c</span>, <span class="id">h</span>) (<span class="id"><a href="CDF.CSL.html#LET">LET</a></span> <span class="id">c</span> (<span class="kwd">fun</span> <span class="id">b</span> =&gt; <span class="id"><a href="CDF.CSL.html#IFTHENELSE">IFTHENELSE</a></span> <span class="id">b</span> (<span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> <span class="id">b</span>) (<span class="id"><a href="CDF.CSL.html#REPEAT">REPEAT</a></span> <span class="id">c</span>)), <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="red_par_done">red_par_done</a></span>: <span class="kwd">forall</span> <span class="id">v1</span> <span class="id">v2</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">red</span> (<span class="id"><a href="CDF.CSL.html#PAR">PAR</a></span> (<span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> <span class="id">v1</span>) (<span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> <span class="id">v2</span>), <span class="id">h</span>) (<span class="id"><a href="CDF.CSL.html#SKIP">SKIP</a></span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="red_par_left">red_par_left</a></span>: <span class="kwd">forall</span> <span class="id">c1</span> <span class="id">c2</span> <span class="id">h</span> <span class="id">c1'</span> <span class="id">h'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">red</span> (<span class="id">c1</span>, <span class="id">h</span>) (<span class="id">c1'</span>, <span class="id">h'</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">red</span> (<span class="id"><a href="CDF.CSL.html#PAR">PAR</a></span> <span class="id">c1</span> <span class="id">c2</span>, <span class="id">h</span>) (<span class="id"><a href="CDF.CSL.html#PAR">PAR</a></span> <span class="id">c1'</span> <span class="id">c2</span>, <span class="id">h'</span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="red_par_right">red_par_right</a></span>: <span class="kwd">forall</span> <span class="id">c1</span> <span class="id">c2</span> <span class="id">h</span> <span class="id">c2'</span> <span class="id">h'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">red</span> (<span class="id">c2</span>, <span class="id">h</span>) (<span class="id">c2'</span>, <span class="id">h'</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">red</span> (<span class="id"><a href="CDF.CSL.html#PAR">PAR</a></span> <span class="id">c1</span> <span class="id">c2</span>, <span class="id">h</span>) (<span class="id"><a href="CDF.CSL.html#PAR">PAR</a></span> <span class="id">c1</span> <span class="id">c2'</span>, <span class="id">h'</span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="red_atomic">red_atomic</a></span>: <span class="kwd">forall</span> <span class="id">c</span> <span class="id">h</span> <span class="id">v</span> <span class="id">h'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="CDF.Sequences.html#star">star</a></span> <span class="id">red</span> (<span class="id">c</span>, <span class="id">h</span>) (<span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> <span class="id">v</span>, <span class="id">h'</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">red</span>  (<span class="id"><a href="CDF.CSL.html#ATOMIC">ATOMIC</a></span> <span class="id">c</span>, <span class="id">h</span>) (<span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> <span class="id">v</span>, <span class="id">h'</span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="red_alloc">red_alloc</a></span>: <span class="kwd">forall</span> <span class="id">sz</span> (<span class="id">h</span>: <span class="id"><a href="CDF.Separation.html#heap">heap</a></span>) <span class="id">l</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">i</span>, <span class="id">l</span> &lt;= <span class="id">i</span> &lt; <span class="id">l</span> + <span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.of_nat">Z.of_nat</a></span> <span class="id">sz</span> -&gt; <span class="id">h</span> <span class="id">i</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">l</span> &lt;&gt; 0 -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">red</span> (<span class="id"><a href="CDF.CSL.html#ALLOC">ALLOC</a></span> <span class="id">sz</span>, <span class="id">h</span>) (<span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> <span class="id">l</span>, <span class="id"><a href="CDF.Separation.html#hinit">hinit</a></span> <span class="id">l</span> <span class="id">sz</span> <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="red_get">red_get</a></span>: <span class="kwd">forall</span> <span class="id">l</span> (<span class="id">h</span>: <span class="id"><a href="CDF.Separation.html#heap">heap</a></span>) <span class="id">v</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h</span> <span class="id">l</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">v</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">red</span> (<span class="id"><a href="CDF.CSL.html#GET">GET</a></span> <span class="id">l</span>, <span class="id">h</span>) (<span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> <span class="id">v</span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="red_set">red_set</a></span>: <span class="kwd">forall</span> <span class="id">l</span> <span class="id">v</span> (<span class="id">h</span>: <span class="id"><a href="CDF.Separation.html#heap">heap</a></span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h</span> <span class="id">l</span> &lt;&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">red</span> (<span class="id"><a href="CDF.CSL.html#SET">SET</a></span> <span class="id">l</span> <span class="id">v</span>, <span class="id">h</span>) (<span class="id"><a href="CDF.CSL.html#SKIP">SKIP</a></span>, <span class="id"><a href="CDF.Separation.html#hupdate">hupdate</a></span> <span class="id">l</span> <span class="id">v</span> <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="red_free">red_free</a></span>: <span class="kwd">forall</span> <span class="id">l</span> (<span class="id">h</span>: <span class="id"><a href="CDF.Separation.html#heap">heap</a></span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h</span> <span class="id">l</span> &lt;&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">red</span> (<span class="id"><a href="CDF.CSL.html#FREE">FREE</a></span> <span class="id">l</span>, <span class="id">h</span>) (<span class="id"><a href="CDF.CSL.html#SKIP">SKIP</a></span>, <span class="id"><a href="CDF.Separation.html#hfree">hfree</a></span> <span class="id">l</span> <span class="id">h</span>).<br/>
<br/>
<div class="doc">Run-time errors. This includes race conditions, where a location is
    immediately accessed by two commands running in parallel. </div>
<br/>
<span class="kwd">Inductive</span> <span class="id"><a name="erroneous">erroneous</a></span>: <span class="id"><a href="CDF.CSL.html#com">com</a></span> * <span class="id"><a href="CDF.Separation.html#heap">heap</a></span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id"><a name="erroneous_let">erroneous_let</a></span>: <span class="kwd">forall</span> <span class="id">c</span> <span class="id">f</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">erroneous</span> (<span class="id">c</span>, <span class="id">h</span>) -&gt; <span class="id">erroneous</span> (<span class="id"><a href="CDF.CSL.html#LET">LET</a></span> <span class="id">c</span> <span class="id">f</span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="erroneous_par_race">erroneous_par_race</a></span>: <span class="kwd">forall</span> <span class="id">c1</span> <span class="id">c2</span> <span class="id">h</span> <span class="id">l</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#immacc">immacc</a></span> <span class="id">l</span> <span class="id">c1</span> /\ <span class="id"><a href="CDF.CSL.html#immacc">immacc</a></span> <span class="id">l</span> <span class="id">c2</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">erroneous</span> (<span class="id"><a href="CDF.CSL.html#PAR">PAR</a></span> <span class="id">c1</span> <span class="id">c2</span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="erroneous_par_l">erroneous_par_l</a></span>: <span class="kwd">forall</span> <span class="id">c1</span> <span class="id">c2</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">erroneous</span> (<span class="id">c1</span>, <span class="id">h</span>) -&gt; <span class="id">erroneous</span> (<span class="id"><a href="CDF.CSL.html#PAR">PAR</a></span> <span class="id">c1</span> <span class="id">c2</span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="erroneous_par_r">erroneous_par_r</a></span>: <span class="kwd">forall</span> <span class="id">c1</span> <span class="id">c2</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">erroneous</span> (<span class="id">c2</span>, <span class="id">h</span>) -&gt; <span class="id">erroneous</span> (<span class="id"><a href="CDF.CSL.html#PAR">PAR</a></span> <span class="id">c1</span> <span class="id">c2</span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="erroneous_atomic">erroneous_atomic</a></span>: <span class="kwd">forall</span> <span class="id">c</span> <span class="id">h</span> <span class="id">c'</span> <span class="id">h'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="CDF.Sequences.html#star">star</a></span> <span class="id"><a href="CDF.CSL.html#red">red</a></span> (<span class="id">c</span>, <span class="id">h</span>) (<span class="id">c'</span>, <span class="id">h'</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">erroneous</span> (<span class="id">c'</span>, <span class="id">h'</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">erroneous</span> (<span class="id"><a href="CDF.CSL.html#ATOMIC">ATOMIC</a></span> <span class="id">c</span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="erroneous_get">erroneous_get</a></span>: <span class="kwd">forall</span> <span class="id">l</span> (<span class="id">h</span>: <span class="id"><a href="CDF.Separation.html#heap">heap</a></span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h</span> <span class="id">l</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span> -&gt; <span class="id">erroneous</span> (<span class="id"><a href="CDF.CSL.html#GET">GET</a></span> <span class="id">l</span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="erroneous_set">erroneous_set</a></span>: <span class="kwd">forall</span> <span class="id">l</span> <span class="id">v</span> (<span class="id">h</span>: <span class="id"><a href="CDF.Separation.html#heap">heap</a></span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h</span> <span class="id">l</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span> -&gt; <span class="id">erroneous</span> (<span class="id"><a href="CDF.CSL.html#SET">SET</a></span> <span class="id">l</span> <span class="id">v</span>, <span class="id">h</span>)<br/>
&nbsp;&nbsp;| <span class="id"><a name="erroneous_free">erroneous_free</a></span>: <span class="kwd">forall</span> <span class="id">l</span> (<span class="id">h</span>: <span class="id"><a href="CDF.Separation.html#heap">heap</a></span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h</span> <span class="id">l</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span> -&gt; <span class="id">erroneous</span> (<span class="id"><a href="CDF.CSL.html#FREE">FREE</a></span> <span class="id">l</span>, <span class="id">h</span>).<br/>
<br/>
<h1> 2.  The rules of concurrent separation logic </h1>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="invariant">invariant</a></span> := <span class="id"><a href="CDF.Separation.html#assertion">assertion</a></span>.<br/>
<span class="kwd">Definition</span> <span class="id"><a name="precond">precond</a></span> := <span class="id"><a href="CDF.Separation.html#assertion">assertion</a></span>.<br/>
<span class="kwd">Definition</span> <span class="id"><a name="postcond">postcond</a></span> := <span class="id"><a href="https://coq.inria.fr/library/Coq.Numbers.BinNums.html#Z">Z</a></span> -&gt; <span class="id"><a href="CDF.Separation.html#assertion">assertion</a></span>.<br/>
<br/>
<h2> 2.1.  Semantic definition of weak triples </h2>
<br/>
<div class="doc">We now define "triples" (actually, quadruples) <span class="bracket"> <span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span> </span>,
  where <span class="bracket"><span class="id">c</span></span> is a command, <span class="bracket"><span class="id">P</span></span> a precondition (on the initial memory heap),
  <span class="bracket"><span class="id">Q</span></span> a postcondition (on the return value and the final memory heap),
  and <span class="bracket"><span class="id">J</span></span> an invariant about the shared heap that is accessed by atomic
  commands.  This is a weak triple: termination is not guaranteed.
  As in the <span class="bracket"><span class="id">Seplog</span></span> module, we define the "triple" semantically
  in terms of a <span class="bracket"><span class="id">safe</span> <span class="id">n</span> <span class="id">c</span> <span class="id">h1</span> <span class="id">Q</span> <span class="id">J</span></span> predicate over the possible reductions
  of command <span class="bracket"><span class="id">c</span></span> in heap <span class="bracket"><span class="id">h1</span></span>.
  The definition of <span class="bracket"><span class="id">safe</span></span> follows Vafeiadis (2011) and uses quantification
  over all possible shared heaps <span class="bracket"><span class="id">hj</span></span> and framing heaps <span class="bracket"><span class="id">hf</span></span>.
  Step-indexing (the <span class="bracket"><span class="id">n</span></span> parameter) provides an induction principle
  over the <span class="bracket"><span class="id">safe</span></span> predicate. </div>
<br/>
<span class="kwd">Inductive</span> <span class="id"><a name="safe">safe</a></span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span> -&gt; <span class="id"><a href="CDF.CSL.html#com">com</a></span> -&gt; <span class="id"><a href="CDF.Separation.html#heap">heap</a></span> -&gt; <span class="id"><a href="CDF.CSL.html#postcond">postcond</a></span> -&gt; <span class="id"><a href="CDF.CSL.html#invariant">invariant</a></span> -&gt; <span class="kwd">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id"><a name="safe_zero">safe_zero</a></span>: <span class="kwd">forall</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span> <span class="id">J</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">safe</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#O">O</a></span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span> <span class="id">J</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="safe_done">safe_done</a></span>: <span class="kwd">forall</span> <span class="id">n</span> <span class="id">v</span> <span class="id">h</span> (<span class="id">Q</span>: <span class="id"><a href="CDF.CSL.html#postcond">postcond</a></span>) (<span class="id">J</span>: <span class="id"><a href="CDF.CSL.html#invariant">invariant</a></span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Q</span> <span class="id">v</span> <span class="id">h</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">safe</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#S">S</a></span> <span class="id">n</span>) (<span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> <span class="id">v</span>) <span class="id">h</span> <span class="id">Q</span> <span class="id">J</span><br/>
&nbsp;&nbsp;| <span class="id"><a name="safe_step">safe_step</a></span>: <span class="kwd">forall</span> <span class="id">n</span> <span class="id">c</span> (<span class="id">h1</span>: <span class="id"><a href="CDF.Separation.html#heap">heap</a></span>) (<span class="id">Q</span>: <span class="id"><a href="CDF.CSL.html#postcond">postcond</a></span>) (<span class="id">J</span>: <span class="id"><a href="CDF.CSL.html#invariant">invariant</a></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">NOTDONE</span>: <span class="kwd">match</span> <span class="id">c</span> <span class="kwd">with</span> <span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> _ =&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#False">False</a></span> | _ =&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Logic.html#True">True</a></span> <span class="kwd">end</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ACC</span>: <span class="kwd">forall</span> <span class="id">l</span>, <span class="id"><a href="CDF.CSL.html#immacc">immacc</a></span> <span class="id">l</span> <span class="id">c</span> -&gt; <span class="id">h1</span> <span class="id">l</span> &lt;&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">IMM</span>: <span class="kwd">forall</span> <span class="id">hf</span> <span class="id">hj</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#hdisj3">hdisj3</a></span> <span class="id">h1</span> <span class="id">hj</span> <span class="id">hf</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h</span> = <span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h1</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">hj</span> <span class="id">hf</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">J</span> <span class="id">hj</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~ <span class="id"><a href="CDF.CSL.html#erroneous">erroneous</a></span> (<span class="id">c</span>, <span class="id">h</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">STEP</span>: <span class="kwd">forall</span> <span class="id">hf</span> <span class="id">hj</span> <span class="id">h</span> <span class="id">c'</span> <span class="id">h'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#hdisj3">hdisj3</a></span> <span class="id">h1</span> <span class="id">hj</span> <span class="id">hf</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h</span> = <span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h1</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">hj</span> <span class="id">hf</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">J</span> <span class="id">hj</span> -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#red">red</a></span> (<span class="id">c</span>, <span class="id">h</span>) (<span class="id">c'</span>, <span class="id">h'</span>) -&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">h1'</span> <span class="id">hj'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#hdisj3">hdisj3</a></span> <span class="id">h1'</span> <span class="id">hj'</span> <span class="id">hf</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h'</span> = <span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h1'</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">hj'</span> <span class="id">hf</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">J</span> <span class="id">hj'</span> /\ <span class="id">safe</span> <span class="id">n</span> <span class="id">c'</span> <span class="id">h1'</span> <span class="id">Q</span> <span class="id">J</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">safe</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#S">S</a></span> <span class="id">n</span>) <span class="id">c</span> <span class="id">h1</span> <span class="id">Q</span> <span class="id">J</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="triple">triple</a></span> (<span class="id">J</span>: <span class="id"><a href="CDF.CSL.html#invariant">invariant</a></span>) (<span class="id">P</span>: <span class="id"><a href="CDF.CSL.html#precond">precond</a></span>) (<span class="id">c</span>: <span class="id"><a href="CDF.CSL.html#com">com</a></span>) (<span class="id">Q</span>: <span class="id"><a href="CDF.CSL.html#postcond">postcond</a></span>) :=<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">n</span> <span class="id">h</span>, <span class="id">P</span> <span class="id">h</span> -&gt; <span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span> <span class="id">J</span>.<br/>
<br/>
<span class="kwd">Notation</span> <span class="string">"J '⊢' ⦃ P ⦄ c ⦃ Q ⦄"</span> := (<span class="id"><a href="CDF.CSL.html#triple">triple</a></span> <span class="id">J</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span>) (<span class="kwd">at</span> <span class="id">level</span> 90, <span class="id">c</span> <span class="kwd">at</span> <span class="id">next</span> <span class="id">level</span>).<br/>
<br/>
<h2> 2.2. Properties about <span class="bracket"><span class="id">safe</span></span> </h2>
<br/>
<span class="kwd">Ltac</span> <span class="id">inv</span> <span class="id">H</span> := <span class="id">inversion</span> <span class="id">H</span>; <span class="id">clear</span> <span class="id">H</span>; <span class="id">subst</span>.<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="safe_pure">safe_pure</a></span>: <span class="kwd">forall</span> <span class="id">n</span> <span class="id">v</span> <span class="id">h</span> (<span class="id">Q</span>: <span class="id"><a href="CDF.CSL.html#postcond">postcond</a></span>) <span class="id">J</span>,<br/>
&nbsp;&nbsp;<span class="id">Q</span> <span class="id">v</span> <span class="id">h</span> -&gt; <span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> (<span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> <span class="id">v</span>) <span class="id">h</span> <span class="id">Q</span> <span class="id">J</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">destruct</span> <span class="id">n</span>; <span class="id">constructor</span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="safe_pure_inv">safe_pure_inv</a></span>: <span class="kwd">forall</span> <span class="id">n</span> <span class="id">v</span> <span class="id">h</span> <span class="id">Q</span> <span class="id">J</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#S">S</a></span> <span class="id">n</span>) (<span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> <span class="id">v</span>) <span class="id">h</span> <span class="id">Q</span> <span class="id">J</span> -&gt; <span class="id">Q</span> <span class="id">v</span> <span class="id">h</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">inv</span> <span class="id">H</span>. <span class="id">auto</span>. <span class="id">contradiction</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="safe_red">safe_red</a></span>: <span class="kwd">forall</span> <span class="id">n</span> <span class="id">c</span> <span class="id">h1</span> <span class="id">Q</span> <span class="id">J</span> <span class="id">hj</span> <span class="id">hf</span> <span class="id">c'</span> <span class="id">h'</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#red">red</a></span> (<span class="id">c</span>, <span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h1</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">hj</span> <span class="id">hf</span>)) (<span class="id">c'</span>, <span class="id">h'</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#S">S</a></span> <span class="id">n</span>) <span class="id">c</span> <span class="id">h1</span> <span class="id">Q</span> <span class="id">J</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">hj</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#hdisj3">hdisj3</a></span> <span class="id">h1</span> <span class="id">hj</span> <span class="id">hf</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">h1'</span> <span class="id">hj'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#hdisj3">hdisj3</a></span> <span class="id">h1'</span> <span class="id">hj'</span> <span class="id">hf</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h'</span> = <span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h1'</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">hj'</span> <span class="id">hf</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">J</span> <span class="id">hj'</span> /\ <span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> <span class="id">c'</span> <span class="id">h1'</span> <span class="id">Q</span> <span class="id">J</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">inv</span> <span class="id">H0</span>.<br/>
- <span class="id">inv</span> <span class="id">H</span>.<br/>
- <span class="id">eauto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="safe_redN">safe_redN</a></span>: <span class="kwd">forall</span> <span class="id">n</span> <span class="id">c</span> <span class="id">h1</span> <span class="id">Q</span> <span class="id">J</span> <span class="id">hj</span> <span class="id">hf</span> <span class="id">c'</span> <span class="id">h'</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Sequences.html#starN">starN</a></span> <span class="id"><a href="CDF.CSL.html#red">red</a></span> <span class="id">n</span> (<span class="id">c</span>, <span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h1</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">hj</span> <span class="id">hf</span>)) (<span class="id">c'</span>, <span class="id">h'</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#S">S</a></span> <span class="id">n</span>) <span class="id">c</span> <span class="id">h1</span> <span class="id">Q</span> <span class="id">J</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">hj</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#hdisj3">hdisj3</a></span> <span class="id">h1</span> <span class="id">hj</span> <span class="id">hf</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">h1'</span> <span class="id">hj'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#hdisj3">hdisj3</a></span> <span class="id">h1'</span> <span class="id">hj'</span> <span class="id">hf</span> /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">h'</span> = <span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h1'</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">hj'</span> <span class="id">hf</span>) /\<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">J</span> <span class="id">hj'</span> /\ <span class="id"><a href="CDF.CSL.html#safe">safe</a></span> 1%<span class="id">nat</span> <span class="id">c'</span> <span class="id">h1'</span> <span class="id">Q</span> <span class="id">J</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">induction</span> <span class="id">n</span>; <span class="id">intros</span>.<br/>
- <span class="id">inv</span> <span class="id">H</span>. <span class="kwd">exists</span> <span class="id">h1</span>, <span class="id">hj</span>; <span class="id">auto</span>.<br/>
- <span class="id">inv</span> <span class="id">H</span>. <span class="id">rename</span> <span class="id">c'</span> <span class="id">into</span> <span class="id">c''</span>. <span class="id">rename</span> <span class="id">h'</span> <span class="id">into</span> <span class="id">h''</span>. <span class="id">destruct</span> <span class="id">b</span> <span class="kwd">as</span> [<span class="id">c'</span> <span class="id">h'</span>].<br/>
&nbsp;&nbsp;<span class="id">edestruct</span> <span class="id"><a href="CDF.CSL.html#safe_red">safe_red</a></span> <span class="kwd">as</span> (<span class="id">h1'</span> &amp; <span class="id">hj'</span> &amp; <span class="id">A</span> &amp; <span class="id">B</span> &amp; <span class="id">C</span> &amp; <span class="id">D</span>).<br/>
&nbsp;&nbsp;<span class="id">eassumption</span>. <span class="id">eassumption</span>. <span class="id">assumption</span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">h'</span>. <span class="id">eapply</span> <span class="id">IHn</span>; <span class="id">eauto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="safe_not_erroneous">safe_not_erroneous</a></span>: <span class="kwd">forall</span> <span class="id">n</span> <span class="id">c</span> <span class="id">h1</span> <span class="id">Q</span> <span class="id">J</span> <span class="id">hj</span> <span class="id">hf</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#S">S</a></span> <span class="id">n</span>) <span class="id">c</span> <span class="id">h1</span> <span class="id">Q</span> <span class="id">J</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#hdisj3">hdisj3</a></span> <span class="id">h1</span> <span class="id">hj</span> <span class="id">hf</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">hj</span> -&gt;<br/>
&nbsp;&nbsp;~ <span class="id"><a href="CDF.CSL.html#erroneous">erroneous</a></span> (<span class="id">c</span>, <span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h1</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">hj</span> <span class="id">hf</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">inv</span> <span class="id">H</span>.<br/>
- <span class="id">intros</span> <span class="id">ST</span>; <span class="id">inv</span> <span class="id">ST</span>.<br/>
- <span class="id">eauto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="safe_immacc">safe_immacc</a></span>: <span class="kwd">forall</span> <span class="id">n</span> <span class="id">c</span> <span class="id">h1</span> <span class="id">Q</span> <span class="id">J</span> <span class="id">l</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#S">S</a></span> <span class="id">n</span>) <span class="id">c</span> <span class="id">h1</span> <span class="id">Q</span> <span class="id">J</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#immacc">immacc</a></span> <span class="id">l</span> <span class="id">c</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">h1</span> <span class="id">l</span> &lt;&gt; <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#None">None</a></span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">inv</span> <span class="id">H</span>.<br/>
- <span class="id">contradiction</span>.<br/>
- <span class="id">eapply</span> <span class="id">ACC</span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="safe_mono">safe_mono</a></span>: <span class="kwd">forall</span> <span class="id">n</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span> <span class="id">J</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span> <span class="id">J</span> -&gt; <span class="kwd">forall</span> <span class="id">n'</span>, (<span class="id">n'</span> &lt;= <span class="id">n</span>)%<span class="id">nat</span> -&gt; <span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n'</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span> <span class="id">J</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">induction</span> <span class="id">n</span>; <span class="id">intros</span>.<br/>
- <span class="id">replace</span> <span class="id">n'</span> <span class="kwd">with</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#O">O</a></span> <span class="kwd">by</span> <span class="id">lia</span>. <span class="id">constructor</span>.<br/>
- <span class="id">destruct</span> <span class="id">n'</span> <span class="kwd">as</span> [ | <span class="id">n'</span>]. <span class="id">constructor</span>. <span class="id">inv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;+ <span class="id">constructor</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">constructor</span>; <span class="id">auto</span>; <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">edestruct</span> <span class="id">STEP</span> <span class="kwd">as</span> (<span class="id">h1'</span> &amp; <span class="id">hj'</span> &amp; <span class="id">A</span> &amp; <span class="id">B</span> &amp; <span class="id">C</span> &amp; <span class="id">D</span>); <span class="id">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">h1'</span>, <span class="id">hj'</span>; <span class="id">intuition</span> <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">IHn</span>; <span class="id">auto</span>. <span class="id">lia</span>.<br/>
Qed.</div></details>
<br/>
<h2> 2.3. The rules of concurrent separation logic </h2>
<br/>
<h3> The frame rule </h3>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="safe_frame">safe_frame</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">R</span>: <span class="id"><a href="CDF.Separation.html#assertion">assertion</a></span>) (<span class="id">Q</span>: <span class="id"><a href="CDF.CSL.html#postcond">postcond</a></span>) <span class="id">J</span> <span class="id">n</span> <span class="id">c</span> <span class="id">h</span> <span class="id">h'</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span> <span class="id">J</span> -&gt; <span class="id"><a href="CDF.Separation.html#hdisjoint">hdisjoint</a></span> <span class="id">h</span> <span class="id">h'</span> -&gt; <span class="id">R</span> <span class="id">h'</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> <span class="id">c</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h</span> <span class="id">h'</span>) (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">Q</span> <span class="id">v</span> ** <span class="id">R</span>) <span class="id">J</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">induction</span> <span class="id">n</span>; <span class="id">intros</span>.<br/>
- <span class="id">constructor</span>.<br/>
- <span class="id">inv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;+ <span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">h</span>, <span class="id">h'</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">constructor</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;* <span class="id">intros</span>. <span class="id">apply</span> <span class="id">ACC</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">cbn</span>. <span class="id">destruct</span> (<span class="id">h</span> <span class="id">l</span>); <span class="id">congruence</span>.<br/>
&nbsp;&nbsp;* <span class="id">intros</span>. <span class="id">subst</span> <span class="id">h0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> (<span class="id">IMM</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h'</span> <span class="id">hf</span>) <span class="id">hj</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>. <span class="id">f_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="kwd">by</span> <span class="id">HDISJ</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>. <span class="id">f_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span>. <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">auto</span>.<br/>
&nbsp;&nbsp;* <span class="id">intros</span>. <span class="id">subst</span> <span class="id">h0</span>. <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">edestruct</span> (<span class="id">STEP</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h'</span> <span class="id">hf</span>) <span class="id">hj</span>) <span class="kwd">as</span> (<span class="id">h1'</span> &amp; <span class="id">hj'</span> &amp; <span class="id">A</span> &amp; <span class="id">B</span> &amp; <span class="id">C</span> &amp; <span class="id">D</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;4: <span class="id">eauto</span>. <span class="id">HDISJ</span>. <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>. <span class="id">f_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="kwd">by</span> <span class="id">HDISJ</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>. <span class="id">f_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span>. <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">h'0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h1'</span> <span class="id">h'</span>), <span class="id">hj'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>. <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>. <span class="id">f_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="kwd">by</span> <span class="id">HDISJ</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>. <span class="id">f_equal</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span>. <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">IHn</span>; <span class="id">auto</span>. <span class="id">HDISJ</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_frame">triple_frame</a></span>: <span class="kwd">forall</span> <span class="id">J</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> ** <span class="id">R</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">Q</span> <span class="id">v</span> ** <span class="id">R</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>; <span class="id">red</span>; <span class="id">intros</span>. <span class="id">destruct</span> <span class="id">H0</span> <span class="kwd">as</span> (<span class="id">h1</span> &amp; <span class="id">h2</span> &amp; <span class="id">P1</span> &amp; <span class="id">R2</span> &amp; <span class="id">D</span> &amp; <span class="id">U</span>). <br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">h</span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_frame">safe_frame</a></span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<h3> The frame rule for invariants </h3>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="safe_frame_invariant">safe_frame_invariant</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">Q</span> (<span class="id">J</span> <span class="id">J'</span>: <span class="id"><a href="CDF.CSL.html#invariant">invariant</a></span>) <span class="id">n</span> <span class="id">c</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span> <span class="id">J</span> -&gt; <br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span> (<span class="id">J</span> ** <span class="id">J'</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">induction</span> <span class="id">n</span>; <span class="id">intros</span>.<br/>
- <span class="id">constructor</span>.<br/>
- <span class="id">inv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;+ <span class="id">constructor</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">constructor</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;* <span class="id">intros</span>. <span class="id">destruct</span> <span class="id">H1</span> <span class="kwd">as</span> (<span class="id">hj1</span> &amp; <span class="id">hj2</span> &amp; <span class="id">A</span> &amp; <span class="id">B</span> &amp; <span class="id">C</span> &amp; <span class="id">D</span>). <span class="id">subst</span> <span class="id">hj</span> <span class="id">h0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> (<span class="id">IMM</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">hj2</span> <span class="id">hf</span>) <span class="id">hj1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">f_equal</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>. <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">auto</span>.<br/>
&nbsp;&nbsp;* <span class="id">intros</span>. <span class="id">destruct</span> <span class="id">H1</span> <span class="kwd">as</span> (<span class="id">hj1</span> &amp; <span class="id">hj2</span> &amp; <span class="id">A</span> &amp; <span class="id">B</span> &amp; <span class="id">C</span> &amp; <span class="id">D</span>). <span class="id">subst</span> <span class="id">hj</span> <span class="id">h0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">edestruct</span> (<span class="id">STEP</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">hj2</span> <span class="id">hf</span>) <span class="id">hj1</span>) <span class="kwd">as</span> (<span class="id">h1'</span> &amp; <span class="id">hj1'</span> &amp; <span class="id">U</span> &amp; <span class="id">V</span> &amp; <span class="id">X</span> &amp; <span class="id">Y</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;4: <span class="id">eauto</span>. <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">f_equal</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>. <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">h'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">h1'</span>, (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">hj1'</span> <span class="id">hj2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>. <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>. <span class="id">f_equal</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>. <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>. <span class="kwd">exists</span> <span class="id">hj1'</span>, <span class="id">hj2</span>; <span class="id">intuition</span> <span class="id">auto</span>. <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">IHn</span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_frame_invariant">triple_frame_invariant</a></span>: <span class="kwd">forall</span> <span class="id">J</span> <span class="id">J'</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> ** <span class="id">J'</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>; <span class="id">red</span>; <span class="id">intros</span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_frame_invariant">safe_frame_invariant</a></span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<h3> Atomic commands </h3>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_atomic">triple_atomic</a></span>: <span class="kwd">forall</span> <span class="id">J</span> <span class="id">P</span> <span class="id">c</span> (<span class="id">Q</span>: <span class="id"><a href="CDF.CSL.html#postcond">postcond</a></span>),<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> ** <span class="id">J</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">Q</span> <span class="id">v</span> ** <span class="id">J</span> <span class="id">⦄</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#ATOMIC">ATOMIC</a></span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">until</span> <span class="id">Q</span>; <span class="id">intros</span> <span class="id">TR</span> <span class="id">n</span> <span class="id">h</span> <span class="id">Ph</span>. <span class="id">destruct</span> <span class="id">n</span>; <span class="id">constructor</span>; <span class="id">auto</span>.<br/>
- <span class="id">intros</span>. <span class="id">intro</span> <span class="id">ST</span>; <span class="id">inv</span> <span class="id">ST</span>. <br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.Sequences.html#star_starN">star_starN</a></span> <span class="kwd">in</span> <span class="id">H4</span>. <span class="id">destruct</span> <span class="id">H4</span> <span class="kwd">as</span> (<span class="id">N</span> &amp; <span class="id">STEPS</span>).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span> <span class="kwd">in</span> <span class="id">STEPS</span>. <span class="id">rewrite</span> &lt;- (<span class="id"><a href="CDF.Separation.html#hunion_empty">hunion_empty</a></span> <span class="id">hf</span>) <span class="kwd">in</span> <span class="id">STEPS</span>.<br/>
&nbsp;&nbsp;<span class="id">edestruct</span> <span class="id"><a href="CDF.CSL.html#safe_redN">safe_redN</a></span> <span class="kwd">as</span> (<span class="id">h1'</span> &amp; <span class="id">hj'</span> &amp; <span class="id">A</span> &amp; <span class="id">B</span> &amp; <span class="id">C</span> &amp; <span class="id">D</span>).<br/>
&nbsp;&nbsp;<span class="id">eexact</span> <span class="id">STEPS</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">TR</span>. <span class="kwd">exists</span> <span class="id">h</span>, <span class="id">hj</span>. <span class="id">intuition</span> <span class="id">auto</span>. <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;<span class="id">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;<span class="id">eelim</span> <span class="id"><a href="CDF.CSL.html#safe_not_erroneous">safe_not_erroneous</a></span>. <span class="id">eexact</span> <span class="id">D</span>. <span class="id">eexact</span> <span class="id">A</span>. <span class="id">eauto</span>. <span class="id">subst</span> <span class="id">h'</span>; <span class="id">auto</span>.<br/>
- <span class="id">intros</span>. <span class="id">inv</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.Sequences.html#star_starN">star_starN</a></span> <span class="kwd">in</span> <span class="id">H4</span>. <span class="id">destruct</span> <span class="id">H4</span> <span class="kwd">as</span> (<span class="id">N</span> &amp; <span class="id">STEPS</span>).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span> <span class="kwd">in</span> <span class="id">STEPS</span>. <span class="id">rewrite</span> &lt;- (<span class="id"><a href="CDF.Separation.html#hunion_empty">hunion_empty</a></span> <span class="id">hf</span>) <span class="kwd">in</span> <span class="id">STEPS</span>.<br/>
&nbsp;&nbsp;<span class="id">edestruct</span> <span class="id"><a href="CDF.CSL.html#safe_redN">safe_redN</a></span> <span class="kwd">as</span> (<span class="id">h1'</span> &amp; <span class="id">hj'</span> &amp; <span class="id">A</span> &amp; <span class="id">B</span> &amp; <span class="id">C</span> &amp; <span class="id">D</span>).<br/>
&nbsp;&nbsp;<span class="id">eexact</span> <span class="id">STEPS</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">TR</span>. <span class="kwd">exists</span> <span class="id">h</span>, <span class="id">hj</span>. <span class="id">intuition</span> <span class="id">auto</span>. <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;<span class="id">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">h'</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_pure_inv">safe_pure_inv</a></span> <span class="kwd">in</span> <span class="id">D</span>. <span class="id">destruct</span> <span class="id">D</span> <span class="kwd">as</span> (<span class="id">h1''</span> &amp; <span class="id">hj''</span> &amp; <span class="id">U</span> &amp; <span class="id">V</span> &amp; <span class="id">X</span> &amp; <span class="id">Y</span>).<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">h1'</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">h1''</span>, <span class="id">hj''</span>.<br/>
&nbsp;&nbsp;<span class="id">split</span>. <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;<span class="id">split</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>. <span class="id">rewrite</span> <span class="id">C</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_empty">hunion_empty</a></span>. <span class="id">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">split</span>. <span class="id">auto</span>. <br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_pure">safe_pure</a></span>. <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<h3> Sharing some state in the invariant </h3>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="safe_share">safe_share</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">Q</span> (<span class="id">J</span> <span class="id">J'</span>: <span class="id"><a href="CDF.CSL.html#invariant">invariant</a></span>) <span class="id">n</span> <span class="id">c</span> <span class="id">h</span> <span class="id">h'</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span> (<span class="id">J</span> ** <span class="id">J'</span>) -&gt; <br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#hdisjoint">hdisjoint</a></span> <span class="id">h</span> <span class="id">h'</span> -&gt; <span class="id">J'</span> <span class="id">h'</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> <span class="id">c</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h</span> <span class="id">h'</span>) (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">Q</span> <span class="id">v</span> ** <span class="id">J'</span>) <span class="id">J</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">induction</span> <span class="id">n</span>; <span class="id">intros</span>.<br/>
- <span class="id">constructor</span>.<br/>
- <span class="id">inv</span> <span class="id">H</span>.<br/>
&nbsp;&nbsp;+ <span class="id">constructor</span>. <span class="kwd">exists</span> <span class="id">h</span>, <span class="id">h'</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">constructor</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;* <span class="id">intros</span>. <span class="id">apply</span> <span class="id">ACC</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">cbn</span>. <span class="id">destruct</span> (<span class="id">h</span> <span class="id">l</span>); <span class="id">congruence</span>.<br/>
&nbsp;&nbsp;* <span class="id">intros</span>. <span class="id">apply</span> (<span class="id">IMM</span> <span class="id">hf</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h'</span> <span class="id">hj</span>)). <span class="id">HDISJ</span>. <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">h0</span>. <span class="id">rewrite</span> ! <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>. <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="kwd">by</span> <span class="id">HDISJ</span>. <span class="kwd">exists</span> <span class="id">hj</span>, <span class="id">h'</span>; <span class="id">intuition</span> <span class="id">auto</span>. <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;* <span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">edestruct</span> (<span class="id">STEP</span> <span class="id">hf</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h'</span> <span class="id">hj</span>)) <span class="kwd">as</span> (<span class="id">h1'</span> &amp; <span class="id">hj'</span> &amp; <span class="id">U</span> &amp; <span class="id">V</span> &amp; <span class="id">X</span> &amp; <span class="id">Y</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;4: <span class="id">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">h0</span>. <span class="id">rewrite</span> ! <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>. <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="kwd">by</span> <span class="id">HDISJ</span>. <span class="kwd">exists</span> <span class="id">hj</span>, <span class="id">h'</span>; <span class="id">intuition</span> <span class="id">auto</span>. <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">X</span> <span class="kwd">as</span> (<span class="id">hj1'</span> &amp; <span class="id">hj2'</span> &amp; <span class="id">A</span> &amp; <span class="id">B</span> &amp; <span class="id">C</span> &amp; <span class="id">D</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">hj'</span> <span class="id">h'0</span> <span class="id">h0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h1'</span> <span class="id">hj2'</span>), <span class="id">hj1'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>. <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>. <span class="id">rewrite</span> (<span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="id">hj2'</span>) <span class="kwd">by</span> <span class="id">HDISJ</span>. <span class="id">rewrite</span> ! <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>. <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>. <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">IHn</span>; <span class="id">auto</span>. <span class="id">HDISJ</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_share">triple_share</a></span>: <span class="kwd">forall</span> <span class="id">J</span> <span class="id">J'</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">J</span> ** <span class="id">J'</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> ** <span class="id">J'</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">Q</span> <span class="id">v</span> ** <span class="id">J'</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;<span class="id">intros</span>; <span class="id">intros</span> <span class="id">n</span> <span class="id">h</span> (<span class="id">h1</span> &amp; <span class="id">h2</span> &amp; <span class="id">Ph1</span> &amp; <span class="id">J'h2</span> &amp; <span class="id">D</span> &amp; <span class="id">U</span>). <span class="id">subst</span> <span class="id">h</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_share">safe_share</a></span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<h3> Sequential commands </h3>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_pure">triple_pure</a></span>: <span class="kwd">forall</span> <span class="id">J</span> <span class="id">P</span> <span class="id">Q</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#aimp">aimp</a></span> <span class="id">P</span> (<span class="id">Q</span> <span class="id">v</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> <span class="id">v</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">J</span> <span class="id">P</span> <span class="id">Q</span> <span class="id">v</span> <span class="id">IMP</span> <span class="id">n</span> <span class="id">h</span> <span class="id">Ph</span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_pure">safe_pure</a></span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="safe_let">safe_let</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">Q</span> <span class="id">R</span>: <span class="id"><a href="CDF.CSL.html#postcond">postcond</a></span>) (<span class="id">J</span>: <span class="id"><a href="CDF.CSL.html#invariant">invariant</a></span>) <span class="id">f</span> <span class="id">n</span> <span class="id">c</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span> <span class="id">J</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">v</span> <span class="id">n'</span> <span class="id">h'</span>, <span class="id">Q</span> <span class="id">v</span> <span class="id">h'</span> -&gt; (<span class="id">n'</span> &lt; <span class="id">n</span>)%<span class="id">nat</span> -&gt; <span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n'</span> (<span class="id">f</span> <span class="id">v</span>) <span class="id">h'</span> <span class="id">R</span> <span class="id">J</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> (<span class="id"><a href="CDF.CSL.html#LET">LET</a></span> <span class="id">c</span> <span class="id">f</span>) <span class="id">h</span> <span class="id">R</span> <span class="id">J</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">induction</span> <span class="id">n</span>; <span class="id">intros</span> <span class="id">until</span> <span class="id">h</span>; <span class="id">intros</span> <span class="id">S1</span> <span class="id">S2</span>.<br/>
- <span class="id">constructor</span>.<br/>
- <span class="id">constructor</span>; <span class="id">auto</span>; <span class="id">intros</span>.<br/>
&nbsp;&nbsp;+ <span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#safe_immacc">safe_immacc</a></span>; <span class="id">eauto</span>. <br/>
&nbsp;&nbsp;+ <span class="id">red</span>; <span class="id">intros</span>. <span class="id">inv</span> <span class="id">H2</span>. <span class="id">eelim</span> <span class="id"><a href="CDF.CSL.html#safe_not_erroneous">safe_not_erroneous</a></span>; <span class="id">eauto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">subst</span> <span class="id">h0</span>. <span class="id">inv</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="kwd">exists</span> <span class="id">h</span>, <span class="id">hj</span>; <span class="id">intuition</span> <span class="id">auto</span>. <span class="id">apply</span> <span class="id">S2</span>. <span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#safe_pure_inv">safe_pure_inv</a></span>; <span class="id">eauto</span>. <span class="id">lia</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id">edestruct</span> <span class="id"><a href="CDF.CSL.html#safe_red">safe_red</a></span> <span class="kwd">as</span> (<span class="id">h1'</span> &amp; <span class="id">hj'</span> &amp; <span class="id">A</span> &amp; <span class="id">B</span> &amp; <span class="id">C</span> &amp; <span class="id">D</span>); <span class="id">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">h1'</span>, <span class="id">hj'</span>; <span class="id">intuition</span> <span class="id">auto</span>. <br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_let">triple_let</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">c</span> <span class="id">f</span> (<span class="id">J</span>: <span class="id"><a href="CDF.CSL.html#invariant">invariant</a></span>) (<span class="id">P</span>: <span class="id"><a href="CDF.CSL.html#precond">precond</a></span>) (<span class="id">Q</span> <span class="id">R</span>: <span class="id"><a href="CDF.CSL.html#postcond">postcond</a></span>),<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">v</span>, <span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">v</span> <span class="id">⦄</span> <span class="id">f</span> <span class="id">v</span> <span class="id">⦃</span> <span class="id">R</span> <span class="id">⦄</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#LET">LET</a></span> <span class="id">c</span> <span class="id">f</span> <span class="id">⦃</span> <span class="id">R</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>; <span class="id">red</span>; <span class="id">intros</span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_let">safe_let</a></span> <span class="kwd">with</span> <span class="id">Q</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id">H</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>; <span class="id">apply</span> <span class="id">H0</span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Corollary</span> <span class="id"><a name="triple_seq">triple_seq</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">c1</span> <span class="id">c2</span> (<span class="id">J</span>: <span class="id"><a href="CDF.CSL.html#invariant">invariant</a></span>) (<span class="id">P</span> <span class="id">Q</span>: <span class="id"><a href="CDF.CSL.html#precond">precond</a></span>) (<span class="id">R</span>: <span class="id"><a href="CDF.CSL.html#postcond">postcond</a></span>),<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id">c1</span> <span class="id">⦃</span> <span class="kwd">fun</span> _ =&gt; <span class="id">Q</span> <span class="id">⦄</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span> <span class="id">c2</span> <span class="id">⦃</span> <span class="id">R</span> <span class="id">⦄</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#SEQ">SEQ</a></span> <span class="id">c1</span> <span class="id">c2</span> <span class="id">⦃</span> <span class="id">R</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_let">triple_let</a></span> <span class="kwd">with</span> (<span class="kwd">fun</span> _ =&gt; <span class="id">Q</span>); <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<h3> Conditionals and loops </h3>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="safe_ifthenelse">safe_ifthenelse</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">n</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span> <span class="id">h</span> <span class="id">Q</span> <span class="id">J</span>,<br/>
&nbsp;&nbsp;(<span class="id">b</span> &lt;&gt; 0 -&gt; <span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> <span class="id">c1</span> <span class="id">h</span> <span class="id">Q</span> <span class="id">J</span>) -&gt;<br/>
&nbsp;&nbsp;(<span class="id">b</span> = 0  -&gt; <span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> <span class="id">c2</span> <span class="id">h</span> <span class="id">Q</span> <span class="id">J</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#S">S</a></span> <span class="id">n</span>) (<span class="id"><a href="CDF.CSL.html#IFTHENELSE">IFTHENELSE</a></span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span>) <span class="id">h</span> <span class="id">Q</span> <span class="id">J</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">constructor</span>; <span class="id">auto</span>; <span class="id">intros</span>.<br/>
- <span class="id">intro</span> <span class="id">ST</span>; <span class="id">inv</span> <span class="id">ST</span>.<br/>
- <span class="id">inv</span> <span class="id">H4</span>. <span class="kwd">exists</span> <span class="id">h</span>, <span class="id">hj</span>; <span class="id">intuition</span> <span class="id">auto</span>. <span class="id">destruct</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.eqb_spec">Z.eqb_spec</a></span> <span class="id">b</span> 0); <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_ifthenelse">triple_ifthenelse</a></span>: <span class="kwd">forall</span> <span class="id">J</span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span> <span class="id">P</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> (<span class="id">b</span> &lt;&gt; 0) //\\ <span class="id">P</span> <span class="id">⦄</span> <span class="id">c1</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> (<span class="id">b</span> = 0) //\\ <span class="id">P</span> <span class="id">⦄</span> <span class="id">c2</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#IFTHENELSE">IFTHENELSE</a></span> <span class="id">b</span> <span class="id">c1</span> <span class="id">c2</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>; <span class="id">red</span>; <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">n</span>. <span class="id">constructor</span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_ifthenelse">safe_ifthenelse</a></span>.<br/>
- <span class="id">intros</span>. <span class="id">apply</span> <span class="id">H</span>. <span class="id">split</span>; <span class="id">auto</span>.<br/>
- <span class="id">intros</span>. <span class="id">apply</span> <span class="id">H0</span>. <span class="id">split</span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_repeat">triple_repeat</a></span>: <span class="kwd">forall</span> <span class="id">J</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#aimp">aimp</a></span> (<span class="id">Q</span> 0) <span class="id">P</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#REPEAT">REPEAT</a></span> <span class="id">c</span> <span class="id">⦃</span> <span class="kwd">fun</span> <span class="id">v</span> =&gt; (<span class="id">v</span> &lt;&gt; 0) //\\ <span class="id">Q</span> <span class="id">v</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">J</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span> <span class="id">TR</span> <span class="id">IMP</span>. <span class="id">red</span>; <span class="id">induction</span> <span class="id">n</span>; <span class="id">intros</span> <span class="id">h</span> <span class="id">Ph</span>.<br/>
- <span class="id">constructor</span>.<br/>
- <span class="id">constructor</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">intros</span>; <span class="id">intro</span> <span class="id">ST</span>. <span class="id">inv</span> <span class="id">ST</span>.<br/>
&nbsp;&nbsp;+ <span class="id">intros</span>. <span class="id">inv</span> <span class="id">H2</span>. <span class="kwd">exists</span> <span class="id">h</span>, <span class="id">hj</span>; <span class="id">intuition</span> <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_let">safe_let</a></span> <span class="kwd">with</span> <span class="id">Q</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id">apply</span> <span class="id">TR</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;* <span class="id">intros</span>. <span class="id">destruct</span> <span class="id">n'</span>. <span class="id">constructor</span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_ifthenelse">safe_ifthenelse</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;** <span class="id">intros</span>. <span class="id">destruct</span> <span class="id">n'</span>; <span class="id">constructor</span>. <span class="id">split</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;** <span class="id">intros</span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_mono">safe_mono</a></span> <span class="kwd">with</span> <span class="id">n</span>. <span class="id">apply</span> <span class="id">IHn</span>. <span class="id">apply</span> <span class="id">IMP</span>. <span class="id">congruence</span>. <span class="id">lia</span>.<br/>
Qed.</div></details>
<br/>
<h3> Parallel composition </h3>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="safe_par">safe_par</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">J</span>: <span class="id"><a href="CDF.CSL.html#invariant">invariant</a></span>) (<span class="id">Q1</span> <span class="id">Q2</span>: <span class="id"><a href="CDF.Separation.html#assertion">assertion</a></span>) <span class="id">n</span> <span class="id">c1</span> <span class="id">h1</span> <span class="id">c2</span> <span class="id">h2</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> <span class="id">c1</span> <span class="id">h1</span> (<span class="kwd">fun</span> _ =&gt; <span class="id">Q1</span>) <span class="id">J</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> <span class="id">c2</span> <span class="id">h2</span> (<span class="kwd">fun</span> _ =&gt; <span class="id">Q2</span>) <span class="id">J</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#hdisjoint">hdisjoint</a></span> <span class="id">h1</span> <span class="id">h2</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> (<span class="id"><a href="CDF.CSL.html#PAR">PAR</a></span> <span class="id">c1</span> <span class="id">c2</span>) (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h1</span> <span class="id">h2</span>) (<span class="kwd">fun</span> _ =&gt; <span class="id">Q1</span> ** <span class="id">Q2</span>) <span class="id">J</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">induction</span> <span class="id">n</span>; <span class="id">intros</span> <span class="id">until</span> <span class="id">h2</span>; <span class="id">intros</span> <span class="id">S1</span> <span class="id">S2</span> <span class="id">DISJ</span>; <span class="id">constructor</span>; <span class="id">auto</span>.<br/>
- <span class="id">cbn</span>; <span class="id">intros</span>. <span class="id">destruct</span> <span class="id">H</span> <span class="kwd">as</span> [<span class="id">H</span> | <span class="id">H</span>]; <span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#safe_immacc">safe_immacc</a></span> <span class="kwd">in</span> <span class="id">H</span>; <span class="id">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">h1</span> <span class="id">l</span>); <span class="id">congruence</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">h1</span> <span class="id">l</span>); <span class="id">congruence</span>.<br/>
- <span class="id">intros</span>. <span class="id">intros</span> <span class="id">ST</span>; <span class="id">inv</span> <span class="id">ST</span>.<br/>
&nbsp;&nbsp;+ <span class="id">destruct</span> <span class="id">H3</span> <span class="kwd">as</span> [<span class="id">IM1</span> <span class="id">IM2</span>].<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#safe_immacc">safe_immacc</a></span> <span class="kwd">in</span> <span class="id">IM1</span>; <span class="id">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#safe_immacc">safe_immacc</a></span> <span class="kwd">in</span> <span class="id">IM2</span>; <span class="id">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">specialize</span> (<span class="id">DISJ</span> <span class="id">l</span>). <span class="id">tauto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">elim</span> (<span class="id"><a href="CDF.CSL.html#safe_not_erroneous">safe_not_erroneous</a></span> _ _ _ _ _ <span class="id">hj</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h2</span> <span class="id">hf</span>) <span class="id">S1</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span> <span class="kwd">in</span> <span class="id">H3</span>. <span class="id">rewrite</span> &lt;- (<span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="id">hj</span>) <span class="kwd">by</span> <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>. <span class="id">rewrite</span> (<span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="id">hj</span>) <span class="kwd">by</span> <span class="id">HDISJ</span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;+ <span class="id">elim</span> (<span class="id"><a href="CDF.CSL.html#safe_not_erroneous">safe_not_erroneous</a></span> _ _ _ _ _ <span class="id">hj</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h1</span> <span class="id">hf</span>) <span class="id">S2</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- (<span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="id">h1</span>) <span class="kwd">in</span> <span class="id">H3</span> <span class="kwd">by</span> <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span> <span class="kwd">in</span> <span class="id">H3</span>. <span class="id">rewrite</span> &lt;- (<span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="id">hj</span>) <span class="kwd">by</span> <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>. <span class="id">rewrite</span> (<span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="id">hj</span>) <span class="kwd">by</span> <span class="id">HDISJ</span>. <span class="id">assumption</span>.<br/>
- <span class="id">intros</span>; <span class="id">subst</span> <span class="id">h</span>. <span class="id">inv</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;c1&nbsp;and&nbsp;c2&nbsp;are&nbsp;PURE&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_pure_inv">safe_pure_inv</a></span> <span class="kwd">in</span> <span class="id">S1</span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_pure_inv">safe_pure_inv</a></span> <span class="kwd">in</span> <span class="id">S2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h1</span> <span class="id">h2</span>), <span class="id">hj</span>; <span class="id">intuition</span> <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_pure">safe_pure</a></span>. <span class="kwd">exists</span> <span class="id">h1</span>, <span class="id">h2</span>; <span class="id">intuition</span> <span class="id">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;c1&nbsp;reduces&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span> <span class="kwd">in</span> <span class="id">H3</span>. <span class="id">rewrite</span> &lt;- (<span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="id">h2</span>) <span class="kwd">in</span> <span class="id">H3</span> <span class="kwd">by</span> <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span> <span class="kwd">in</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="CDF.CSL.html#safe_red">safe_red</a></span> _ _ _ _ _ _ _ _ _ <span class="id">H3</span> <span class="id">S1</span>) <span class="kwd">as</span> (<span class="id">h1'</span> &amp; <span class="id">hj'</span> &amp; <span class="id">A</span> &amp; <span class="id">B</span> &amp; <span class="id">C</span> &amp; <span class="id">D</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">auto</span>. <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">h'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h1'</span> <span class="id">h2</span>), <span class="id">hj'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>. <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>. <span class="id">f_equal</span>. <span class="id">rewrite</span> &lt;- (<span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="id">h2</span>) <span class="kwd">by</span> <span class="id">HDISJ</span>. <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>. <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">IHn</span>. <span class="id">auto</span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_mono">safe_mono</a></span> <span class="kwd">with</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#S">S</a></span> <span class="id">n</span>); <span class="id">auto</span>. <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;+ <span class="comment">(*&nbsp;c2&nbsp;reduces&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- (<span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="id">h1</span>) <span class="kwd">in</span> <span class="id">H3</span> <span class="kwd">by</span> <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span> <span class="kwd">in</span> <span class="id">H3</span>. <span class="id">rewrite</span> &lt;- (<span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="id">h1</span>) <span class="kwd">in</span> <span class="id">H3</span> <span class="kwd">by</span> <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span> <span class="kwd">in</span> <span class="id">H3</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="CDF.CSL.html#safe_red">safe_red</a></span> _ _ _ _ _ _ _ _ _ <span class="id">H3</span> <span class="id">S2</span>) <span class="kwd">as</span> (<span class="id">h2'</span> &amp; <span class="id">hj'</span> &amp; <span class="id">A</span> &amp; <span class="id">B</span> &amp; <span class="id">C</span> &amp; <span class="id">D</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">auto</span>. <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">h'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h2'</span> <span class="id">h1</span>), <span class="id">hj'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>. <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>. <span class="id">f_equal</span>. <span class="id">rewrite</span> &lt;- (<span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="id">h1</span>) <span class="kwd">by</span> <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>. <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">split</span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="kwd">by</span> <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id">IHn</span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_mono">safe_mono</a></span> <span class="kwd">with</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#S">S</a></span> <span class="id">n</span>); <span class="id">auto</span>. <span class="id">auto</span>. <span class="id">HDISJ</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_par">triple_par</a></span>: <span class="kwd">forall</span> <span class="id">J</span> <span class="id">P1</span> <span class="id">c1</span> <span class="id">Q1</span> <span class="id">P2</span> <span class="id">c2</span> <span class="id">Q2</span>,<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P1</span> <span class="id">⦄</span> <span class="id">c1</span> <span class="id">⦃</span> <span class="kwd">fun</span> _ =&gt; <span class="id">Q1</span> <span class="id">⦄</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P2</span> <span class="id">⦄</span> <span class="id">c2</span> <span class="id">⦃</span> <span class="kwd">fun</span> _ =&gt; <span class="id">Q2</span> <span class="id">⦄</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P1</span> ** <span class="id">P2</span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#PAR">PAR</a></span> <span class="id">c1</span> <span class="id">c2</span> <span class="id">⦃</span> <span class="kwd">fun</span> _ =&gt; <span class="id">Q1</span> ** <span class="id">Q2</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">until</span> <span class="id">Q2</span>; <span class="id">intros</span> <span class="id">TR1</span> <span class="id">TR2</span> <span class="id">n</span> <span class="id">h</span> <span class="id">Ph</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">Ph</span> <span class="kwd">as</span> (<span class="id">h1</span> &amp; <span class="id">h2</span> &amp; <span class="id">Ph1</span> &amp; <span class="id">Ph2</span> &amp; <span class="id">D</span> &amp; <span class="id">U</span>).<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">h</span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_par">safe_par</a></span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<h3> The "small rules" for heap operations </h3>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_get">triple_get</a></span>: <span class="kwd">forall</span> <span class="id">J</span> <span class="id">l</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">l</span> <span class="id">v</span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#GET">GET</a></span> <span class="id">l</span> <span class="id">⦃</span> <span class="kwd">fun</span> <span class="id">v'</span> =&gt; (<span class="id">v'</span> = <span class="id">v</span>) //\\ <span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">l</span> <span class="id">v</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">J</span> <span class="id">l</span> <span class="id">v</span> <span class="id">n</span> <span class="id">h</span> <span class="id">Ph</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">L</span>: <span class="id">h</span> <span class="id">l</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">v</span>) <span class="kwd">by</span> (<span class="id">rewrite</span> <span class="id">Ph</span>; <span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#hupdate_same">hupdate_same</a></span>).<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">n</span>; <span class="id">constructor</span>; <span class="id">auto</span>.<br/>
- <span class="id">cbn</span>; <span class="id">intros</span>. <span class="id">congruence</span>.<br/>
- <span class="id">intros</span>. <span class="id">subst</span> <span class="id">h0</span>. <span class="id">intro</span> <span class="id">ST</span>; <span class="id">inv</span> <span class="id">ST</span>. <span class="id">cbn</span> <span class="kwd">in</span> <span class="id">H2</span>. <span class="id">rewrite</span> <span class="id">L</span> <span class="kwd">in</span> <span class="id">H2</span>. <span class="id">congruence</span>.<br/>
- <span class="id">intros</span>. <span class="id">subst</span> <span class="id">h0</span>. <span class="id">inv</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">v0</span> = <span class="id">v</span>). <br/>
&nbsp;&nbsp;{ <span class="id">cbn</span> <span class="kwd">in</span> <span class="id">H3</span>. <span class="id">rewrite</span> <span class="id">L</span> <span class="kwd">in</span> <span class="id">H3</span>. <span class="id">congruence</span>. }<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">v0</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">h</span>, <span class="id">hj</span>; <span class="id">intuition</span> <span class="id">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_pure">safe_pure</a></span>. <span class="id">split</span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_set">triple_set</a></span>: <span class="kwd">forall</span> <span class="id">J</span> <span class="id">l</span> <span class="id">v</span>,<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id"><a href="CDF.Separation.html#valid">valid</a></span> <span class="id">l</span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#SET">SET</a></span> <span class="id">l</span> <span class="id">v</span> <span class="id">⦃</span> <span class="kwd">fun</span> _ =&gt; <span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">l</span> <span class="id">v</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">J</span> <span class="id">l</span> <span class="id">v</span> <span class="id">n</span> <span class="id">h</span> <span class="id">Ph</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">Ph</span> <span class="kwd">as</span> (<span class="id">v0</span> &amp; <span class="id">Ph</span>).<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">L</span>: <span class="id">h</span> <span class="id">l</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">v0</span>) <span class="kwd">by</span> (<span class="id">rewrite</span> <span class="id">Ph</span>; <span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#hupdate_same">hupdate_same</a></span>).<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">n</span>; <span class="id">constructor</span>; <span class="id">auto</span>.<br/>
- <span class="id">cbn</span>; <span class="id">intros</span>. <span class="id">congruence</span>.<br/>
- <span class="id">intros</span>; <span class="id">intro</span> <span class="id">ST</span>; <span class="id">inv</span> <span class="id">ST</span>. <span class="id">cbn</span> <span class="kwd">in</span> <span class="id">H3</span>. <span class="id">rewrite</span> <span class="id">L</span> <span class="kwd">in</span> <span class="id">H3</span>; <span class="id">congruence</span>.<br/>
- <span class="id">intros</span>. <span class="id">subst</span> <span class="id">h0</span>. <span class="id">rewrite</span> <span class="id">Ph</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">inv</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id"><a href="CDF.Separation.html#hupdate">hupdate</a></span> <span class="id">l</span> <span class="id">v</span> <span class="id"><a href="CDF.Separation.html#hempty">hempty</a></span>), <span class="id">hj</span>; <span class="id">intuition</span> <span class="id">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">HDISJ</span>. <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">red</span>; <span class="id">intros</span> <span class="id">l0</span>; <span class="id">generalize</span> (<span class="id">H</span> <span class="id">l0</span>); <span class="id">cbn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.eq_dec">Z.eq_dec</a></span> <span class="id">l</span> <span class="id">l0</span>); <span class="id">intuition</span> <span class="id">congruence</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">red</span>; <span class="id">intros</span> <span class="id">l0</span>; <span class="id">generalize</span> (<span class="id">H0</span> <span class="id">l0</span>); <span class="id">cbn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.eq_dec">Z.eq_dec</a></span> <span class="id">l</span> <span class="id">l0</span>); <span class="id">intuition</span> <span class="id">congruence</span>.<br/>
&nbsp;&nbsp;+ <span class="id">rewrite</span> <span class="id">Ph</span>. <span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#heap_extensionality">heap_extensionality</a></span>; <span class="id">intros</span> <span class="id">l0</span>; <span class="id">cbn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.eq_dec">Z.eq_dec</a></span> <span class="id">l</span> <span class="id">l0</span>); <span class="id">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_pure">safe_pure</a></span>. <span class="id">reflexivity</span>. <br/>
Qed.</div></details>
<br/>
<span class="kwd">Fixpoint</span> <span class="id"><a name="valid_N">valid_N</a></span> (<span class="id">l</span>: <span class="id"><a href="CDF.Separation.html#addr">addr</a></span>) (<span class="id">sz</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nat">nat</a></span>) : <span class="id"><a href="CDF.Separation.html#assertion">assertion</a></span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">sz</span> <span class="kwd">with</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#O">O</a></span> =&gt; <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> | <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#S">S</a></span> <span class="id">sz</span> =&gt; <span class="id"><a href="CDF.Separation.html#valid">valid</a></span> <span class="id">l</span> ** <span class="id">valid_N</span> (<span class="id">l</span> + 1) <span class="id">sz</span> <span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Remark</span> <span class="id"><a name="valid_N_init">valid_N_init</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">sz</span> <span class="id">l</span>,<br/>
&nbsp;&nbsp;(<span class="id"><a href="CDF.CSL.html#valid_N">valid_N</a></span> <span class="id">l</span> <span class="id">sz</span>) (<span class="id"><a href="CDF.Separation.html#hinit">hinit</a></span> <span class="id">l</span> <span class="id">sz</span> <span class="id"><a href="CDF.Separation.html#hempty">hempty</a></span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">induction</span> <span class="id">sz</span> <span class="kwd">as</span> [ | <span class="id">sz</span>]; <span class="id">intros</span> <span class="id">l</span>; <span class="id">cbn</span>.<br/>
- <span class="id">red</span>; <span class="id">auto</span>.<br/>
- <span class="kwd">exists</span> (<span class="id"><a href="CDF.Separation.html#hupdate">hupdate</a></span> <span class="id">l</span> 0 <span class="id"><a href="CDF.Separation.html#hempty">hempty</a></span>), (<span class="id"><a href="CDF.Separation.html#hinit">hinit</a></span> (<span class="id">l</span> + 1) <span class="id">sz</span> <span class="id"><a href="CDF.Separation.html#hempty">hempty</a></span>).<br/>
&nbsp;&nbsp;<span class="id">split</span>. <span class="kwd">exists</span> 0. <span class="id">red</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">split</span>. <span class="id">apply</span> <span class="id">IHsz</span>.<br/>
&nbsp;&nbsp;<span class="id">split</span>. <span class="id">intros</span> <span class="id">x</span>. <span class="id">unfold</span> <span class="id"><a href="CDF.Separation.html#hupdate">hupdate</a></span>, <span class="id"><a href="CDF.Separation.html#hempty">hempty</a></span> <span class="kwd">at</span> 1; <span class="id">cbn</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.eq_dec">Z.eq_dec</a></span> <span class="id">l</span> <span class="id">x</span>); <span class="id">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">right</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hinit_outside">hinit_outside</a></span> <span class="kwd">by</span> <span class="id">lia</span>. <span class="id">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#heap_extensionality">heap_extensionality</a></span>; <span class="id">intros</span> <span class="id">x</span>. <span class="id">cbn</span>. <span class="id">destruct</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.eq_dec">Z.eq_dec</a></span> <span class="id">l</span> <span class="id">x</span>); <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_alloc">triple_alloc</a></span>: <span class="kwd">forall</span> <span class="id">J</span> <span class="id">sz</span>,<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="id">⦄</span>  <span class="id"><a href="CDF.CSL.html#ALLOC">ALLOC</a></span> <span class="id">sz</span>  <span class="id">⦃</span> <span class="kwd">fun</span> <span class="id">l</span> =&gt; (<span class="id">l</span> &lt;&gt; 0) //\\ <span class="id"><a href="CDF.CSL.html#valid_N">valid_N</a></span> <span class="id">l</span> <span class="id">sz</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">J</span> <span class="id">sz</span> <span class="id">n</span> <span class="id">h</span> <span class="id">Ph</span>. <span class="id">red</span> <span class="kwd">in</span> <span class="id">Ph</span>; <span class="id">subst</span> <span class="id">h</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">n</span>; <span class="id">constructor</span>; <span class="id">auto</span>.<br/>
- <span class="id">intros</span>; <span class="id">intro</span> <span class="id">ST</span>. <span class="id">inv</span> <span class="id">ST</span>. <br/>
- <span class="id">intros</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hunion_empty">hunion_empty</a></span> <span class="kwd">in</span> <span class="id">H0</span>. <span class="id">subst</span> <span class="id">h</span>. <span class="id">inv</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> (<span class="id"><a href="CDF.Separation.html#hinit">hinit</a></span> <span class="id">l</span> <span class="id">sz</span> <span class="id"><a href="CDF.Separation.html#hempty">hempty</a></span>), <span class="id">hj</span>; <span class="id">intuition</span> <span class="id">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">assert</span> (<span class="id">D</span>: <span class="id"><a href="CDF.Separation.html#hdisjoint">hdisjoint</a></span> (<span class="id"><a href="CDF.Separation.html#hinit">hinit</a></span> <span class="id">l</span> <span class="id">sz</span> <span class="id"><a href="CDF.Separation.html#hempty">hempty</a></span>) (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">hj</span> <span class="id">hf</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">red</span>; <span class="id">intros</span> <span class="id">l0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">EITHER</span>: <span class="id">l</span> &lt;= <span class="id">l0</span> &lt; <span class="id">l</span> + <span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.of_nat">Z.of_nat</a></span> <span class="id">sz</span> \/ <span class="id">l0</span> &lt; <span class="id">l</span> \/ <span class="id">l</span> + <span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.of_nat">Z.of_nat</a></span> <span class="id">sz</span> &lt;= <span class="id">l0</span>) <span class="kwd">by</span> <span class="id">lia</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">EITHER</span>. <span class="id">right</span>; <span class="id">auto</span>. <span class="id">left</span>; <span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#hinit_outside">hinit_outside</a></span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;+ <span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#heap_extensionality">heap_extensionality</a></span>; <span class="id">intros</span> <span class="id">l0</span>; <span class="id">cbn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">EITHER</span>: <span class="id">l</span> &lt;= <span class="id">l0</span> &lt; <span class="id">l</span> + <span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.of_nat">Z.of_nat</a></span> <span class="id">sz</span> \/ <span class="id">l0</span> &lt; <span class="id">l</span> \/ <span class="id">l</span> + <span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.of_nat">Z.of_nat</a></span> <span class="id">sz</span> &lt;= <span class="id">l0</span>) <span class="kwd">by</span> <span class="id">lia</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">EITHER</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> ! <span class="id"><a href="CDF.Separation.html#hinit_inside">hinit_inside</a></span> <span class="kwd">by</span> <span class="id">auto</span>. <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> ! <span class="id"><a href="CDF.Separation.html#hinit_outside">hinit_outside</a></span> <span class="kwd">by</span> <span class="id">auto</span>. <span class="id">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_pure">safe_pure</a></span>. <span class="id">split</span>. <span class="id">auto</span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#valid_N_init">valid_N_init</a></span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_free">triple_free</a></span>: <span class="kwd">forall</span> <span class="id">J</span> <span class="id">l</span>,<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id"><a href="CDF.Separation.html#valid">valid</a></span> <span class="id">l</span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#FREE">FREE</a></span> <span class="id">l</span> <span class="id">⦃</span> <span class="kwd">fun</span> _ =&gt; <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">J</span> <span class="id">l</span> <span class="id">n</span> <span class="id">h</span> <span class="id">Ph</span>.<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">Ph</span> <span class="kwd">as</span> (<span class="id">v0</span> &amp; <span class="id">Ph</span>).<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">L</span>: <span class="id">h</span> <span class="id">l</span> = <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#Some">Some</a></span> <span class="id">v0</span>) <span class="kwd">by</span> (<span class="id">rewrite</span> <span class="id">Ph</span>; <span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#hupdate_same">hupdate_same</a></span>).<br/>
&nbsp;&nbsp;<span class="id">destruct</span> <span class="id">n</span>; <span class="id">constructor</span>; <span class="id">auto</span>.<br/>
- <span class="id">cbn</span>; <span class="id">intros</span>. <span class="id">congruence</span>.<br/>
- <span class="id">intros</span>; <span class="id">intro</span> <span class="id">ST</span>; <span class="id">inv</span> <span class="id">ST</span>. <span class="id">cbn</span> <span class="kwd">in</span> <span class="id">H3</span>. <span class="id">rewrite</span> <span class="id">L</span> <span class="kwd">in</span> <span class="id">H3</span>; <span class="id">congruence</span>.<br/>
- <span class="id">intros</span>. <span class="id">subst</span> <span class="id">h0</span>. <span class="id">rewrite</span> <span class="id">Ph</span> <span class="kwd">in</span> <span class="id">H</span>. <span class="id">inv</span> <span class="id">H2</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id"><a href="CDF.Separation.html#hempty">hempty</a></span>, <span class="id">hj</span>; <span class="id">intuition</span> <span class="id">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">HDISJ</span>. <br/>
&nbsp;&nbsp;+ <span class="id">assert</span> (<span class="id">D</span>: <span class="id"><a href="CDF.Separation.html#hdisjoint">hdisjoint</a></span> (<span class="id"><a href="CDF.Separation.html#hupdate">hupdate</a></span> <span class="id">l</span> <span class="id">v0</span> <span class="id"><a href="CDF.Separation.html#hempty">hempty</a></span>) (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">hj</span> <span class="id">hf</span>)) <span class="kwd">by</span> <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id">Ph</span>. <span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#heap_extensionality">heap_extensionality</a></span>; <span class="id">intros</span> <span class="id">l0</span>; <span class="id">cbn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.eq_dec">Z.eq_dec</a></span> <span class="id">l</span> <span class="id">l0</span>); <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">subst</span> <span class="id">l0</span>. <span class="id">destruct</span> (<span class="id">D</span> <span class="id">l</span>); <span class="id">auto</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#hupdate_same">hupdate_same</a></span> <span class="kwd">in</span> <span class="id">H0</span>; <span class="id">congruence</span>.<br/>
&nbsp;&nbsp;+ <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_pure">safe_pure</a></span>. <span class="id">reflexivity</span>. <br/>
Qed.</div></details>
<br/>
<h3> Structural rules </h3>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_consequence_pre">triple_consequence_pre</a></span>: <span class="kwd">forall</span> <span class="id">P'</span> <span class="id">J</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P'</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#aimp">aimp</a></span> <span class="id">P</span> <span class="id">P'</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">intros</span> <span class="id">n</span> <span class="id">h</span> <span class="id">Ph</span>. <span class="id">apply</span> <span class="id">H</span>. <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="safe_consequence">safe_consequence</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> (<span class="id">Q</span> <span class="id">Q'</span>: <span class="id"><a href="CDF.CSL.html#postcond">postcond</a></span>) (<span class="id">J</span>: <span class="id"><a href="CDF.CSL.html#invariant">invariant</a></span>),<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">v</span>, <span class="id"><a href="CDF.Separation.html#aimp">aimp</a></span> (<span class="id">Q'</span> <span class="id">v</span>) (<span class="id">Q</span> <span class="id">v</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">n</span> <span class="id">c</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q'</span> <span class="id">J</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span> <span class="id">J</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">induction</span> <span class="id">n</span>; <span class="id">intros</span>. <br/>
- <span class="id">constructor</span>.<br/>
- <span class="id">inv</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;+ <span class="id">constructor</span>. <span class="id">apply</span> <span class="id">H</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">constructor</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">edestruct</span> <span class="id">STEP</span> <span class="kwd">as</span> (<span class="id">h1'</span> &amp; <span class="id">hj'</span> &amp; <span class="id">A</span> &amp; <span class="id">B</span> &amp; <span class="id">C</span> &amp; <span class="id">D</span>); <span class="id">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">h1'</span>, <span class="id">hj'</span>; <span class="id">intuition</span> <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_consequence_post">triple_consequence_post</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">Q'</span> <span class="id">J</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q'</span> <span class="id">⦄</span> -&gt;<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">v</span>, <span class="id"><a href="CDF.Separation.html#aimp">aimp</a></span> (<span class="id">Q'</span> <span class="id">v</span>) (<span class="id">Q</span> <span class="id">v</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">intros</span> <span class="id">n</span> <span class="id">h</span> <span class="id">Ph</span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_consequence">safe_consequence</a></span> <span class="kwd">with</span> <span class="id">Q'</span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_exists_pre">triple_exists_pre</a></span>: <span class="kwd">forall</span> {<span class="id">X</span>: <span class="kwd">Type</span>} <span class="id">J</span> (<span class="id">P</span>: <span class="id">X</span> -&gt; <span class="id"><a href="CDF.Separation.html#assertion">assertion</a></span>) <span class="id">c</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">v</span>, <span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">v</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id"><a href="CDF.Separation.html#aexists">aexists</a></span> <span class="id">P</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">intros</span> <span class="id">n</span> <span class="id">h</span> <span class="id">Ph</span>. <span class="id">destruct</span> <span class="id">Ph</span> <span class="kwd">as</span> (<span class="id">v</span> &amp; <span class="id">Ph</span>). <span class="id">apply</span> (<span class="id">H</span> <span class="id">v</span>). <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_simple_conj_pre">triple_simple_conj_pre</a></span>: <span class="kwd">forall</span> <span class="id">J</span> (<span class="id">P1</span>: <span class="kwd">Prop</span>) <span class="id">P2</span> <span class="id">c</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;(<span class="id">P1</span> -&gt; <span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P2</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span>) -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P1</span> //\\ <span class="id">P2</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">intros</span> <span class="id">n</span> <span class="id">h</span> <span class="id">Ph</span>. <span class="id">destruct</span> <span class="id">Ph</span>. <span class="id">apply</span> <span class="id">H</span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_or">triple_or</a></span>: <span class="kwd">forall</span> <span class="id">J</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span> <span class="id">P'</span> <span class="id">Q'</span>,<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span> -&gt; <span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P'</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q'</span> <span class="id">⦄</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id"><a href="CDF.Separation.html#aor">aor</a></span> <span class="id">P</span> <span class="id">P'</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id"><a href="CDF.Separation.html#aor">aor</a></span> (<span class="id">Q</span> <span class="id">v</span>) (<span class="id">Q'</span> <span class="id">v</span>) <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">until</span> <span class="id">Q'</span>; <span class="id">intros</span> <span class="id">TR1</span> <span class="id">TR2</span> <span class="id">n</span> <span class="id">h</span> [<span class="id">Ph</span> | <span class="id">P'h</span>].<br/>
- <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_consequence">safe_consequence</a></span> <span class="kwd">with</span> <span class="id">Q</span>. <span class="id">intros</span> <span class="id">v1</span> <span class="id">h1</span>; <span class="id">red</span>; <span class="id">auto</span>. <span class="id">apply</span> <span class="id">TR1</span>; <span class="id">auto</span>.<br/>
- <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_consequence">safe_consequence</a></span> <span class="kwd">with</span> <span class="id">Q'</span>. <span class="id">intros</span> <span class="id">v1</span> <span class="id">h1</span>; <span class="id">red</span>; <span class="id">auto</span>. <span class="id">apply</span> <span class="id">TR2</span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="safe_and">safe_and</a></span>: <span class="kwd">forall</span> <span class="id">J</span> <span class="id">Q</span> <span class="id">Q'</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#precise">precise</a></span> <span class="id">J</span> -&gt;<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">n</span> <span class="id">c</span> <span class="id">h</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q</span> <span class="id">J</span> -&gt; <span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> <span class="id">c</span> <span class="id">h</span> <span class="id">Q'</span> <span class="id">J</span> -&gt; <span class="id"><a href="CDF.CSL.html#safe">safe</a></span> <span class="id">n</span> <span class="id">c</span> <span class="id">h</span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id"><a href="CDF.Separation.html#aand">aand</a></span> (<span class="id">Q</span> <span class="id">v</span>) (<span class="id">Q'</span> <span class="id">v</span>)) <span class="id">J</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">induction</span> <span class="id">n</span>; <span class="id">intros</span> <span class="id">c</span> <span class="id">h</span> <span class="id">S</span> <span class="id">S'</span>. <br/>
- <span class="id">constructor</span>.<br/>
- <span class="id">inv</span> <span class="id">S</span>; <span class="id">inv</span> <span class="id">S'</span>.<br/>
+ <span class="id">constructor</span>; <span class="id">split</span>; <span class="id">auto</span>.<br/>
+ <span class="id">contradiction</span>.<br/>
+ <span class="id">contradiction</span>.<br/>
+ <span class="id">constructor</span>; <span class="id">auto</span>.<br/>
* <span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">edestruct</span> <span class="id">STEP</span> <span class="kwd">as</span> (<span class="id">h1'</span> &amp; <span class="id">hj'</span> &amp; <span class="id">D'</span> &amp; <span class="id">E'</span> &amp; <span class="id">J'</span> &amp; <span class="id">SAFE'</span>); <span class="id">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">edestruct</span> <span class="id">STEP0</span> <span class="kwd">as</span> (<span class="id">h1''</span> &amp; <span class="id">hj''</span> &amp; <span class="id">D''</span> &amp; <span class="id">E''</span> &amp; <span class="id">J''</span> &amp; <span class="id">SAFE''</span>); <span class="id">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">hj'</span> = <span class="id">hj''</span>).<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id">H</span> <span class="kwd">with</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h1'</span> <span class="id">hf</span>) (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">h1''</span> <span class="id">hf</span>); <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">HDISJ</span>. <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> ! (<span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="id">hf</span>) <span class="kwd">by</span> <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- ! <span class="id"><a href="CDF.Separation.html#hunion_assoc">hunion_assoc</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="id">h1'</span>), (<span class="id"><a href="CDF.Separation.html#hunion_comm">hunion_comm</a></span> <span class="id">h1''</span>) <span class="kwd">by</span> <span class="id">HDISJ</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">congruence</span>.<br/>
&nbsp;&nbsp;}<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">hj''</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> (<span class="id">h1'</span> = <span class="id">h1''</span>).<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#hunion_invert_l">hunion_invert_l</a></span> <span class="kwd">with</span> (<span class="id"><a href="CDF.Separation.html#hunion">hunion</a></span> <span class="id">hj'</span> <span class="id">hf</span>). <span class="id">congruence</span>. <span class="id">HDISJ</span>. <span class="id">HDISJ</span>. }<br/>
&nbsp;&nbsp;<span class="id">subst</span> <span class="id">h1''</span>.<br/>
&nbsp;&nbsp;<span class="kwd">exists</span> <span class="id">h1'</span>, <span class="id">hj'</span>; <span class="id">auto</span>. <br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_and">triple_and</a></span>: <span class="kwd">forall</span> <span class="id">J</span> <span class="id">P</span> <span class="id">c</span> <span class="id">Q</span> <span class="id">P'</span> <span class="id">Q'</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#precise">precise</a></span> <span class="id">J</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span> -&gt; <span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P'</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q'</span> <span class="id">⦄</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id">J</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id"><a href="CDF.Separation.html#aand">aand</a></span> <span class="id">P</span> <span class="id">P'</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id"><a href="CDF.Separation.html#aand">aand</a></span> (<span class="id">Q</span> <span class="id">v</span>) (<span class="id">Q'</span> <span class="id">v</span>) <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">until</span> <span class="id">Q'</span>; <span class="id">intros</span> <span class="id">PR</span> <span class="id">TR1</span> <span class="id">TR2</span> <span class="id">n</span> <span class="id">h</span> (<span class="id">Ph</span> &amp; <span class="id">P'h</span>).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#safe_and">safe_and</a></span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<h1> 3. Mutual exclusion </h1>
<br/>
<h2> 3.1.  Binary semaphores </h2>
<br/>
<div class="doc">A binary semaphore is a memory location that contains 0 if it is empty
    and 1 if it is busy. </div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="sem_invariant">sem_invariant</a></span> (<span class="id">lck</span>: <span class="id"><a href="CDF.Separation.html#addr">addr</a></span>) (<span class="id">R</span>: <span class="id"><a href="CDF.Separation.html#assertion">assertion</a></span>) : <span class="id"><a href="CDF.Separation.html#assertion">assertion</a></span> :=<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#aexists">aexists</a></span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">lck</span> <span class="id">v</span> ** (<span class="kwd">if</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.eqb">Z.eqb</a></span> <span class="id">v</span> 0 <span class="kwd">then</span> <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="kwd">else</span> <span class="id">R</span>)).<br/>
<br/>
<div class="doc">Acquiring a semaphore (the P operation) is achieved by atomically
    setting it to 0 until its previous value was not 0. </div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="SWAP">SWAP</a></span> (<span class="id">l</span>: <span class="id"><a href="CDF.Separation.html#addr">addr</a></span>) (<span class="id">new_v</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Numbers.BinNums.html#Z">Z</a></span>) : <span class="id"><a href="CDF.CSL.html#com">com</a></span> :=<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#ATOMIC">ATOMIC</a></span> (<span class="id"><a href="CDF.CSL.html#LET">LET</a></span> (<span class="id"><a href="CDF.CSL.html#GET">GET</a></span> <span class="id">l</span>) (<span class="kwd">fun</span> <span class="id">old_v</span> =&gt; <span class="id"><a href="CDF.CSL.html#SEQ">SEQ</a></span> (<span class="id"><a href="CDF.CSL.html#SET">SET</a></span> <span class="id">l</span> <span class="id">new_v</span>) (<span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> <span class="id">old_v</span>))).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="ACQUIRE">ACQUIRE</a></span> (<span class="id">lck</span>: <span class="id"><a href="CDF.Separation.html#addr">addr</a></span>) : <span class="id"><a href="CDF.CSL.html#com">com</a></span> :=<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#REPEAT">REPEAT</a></span> (<span class="id"><a href="CDF.CSL.html#SWAP">SWAP</a></span> <span class="id">lck</span> 0).<br/>
<br/>
<div class="doc">Releasing a semaphore (the V operation) is achieved by atomically
    setting it to 1. </div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="RELEASE">RELEASE</a></span> (<span class="id">lck</span>: <span class="id"><a href="CDF.Separation.html#addr">addr</a></span>) : <span class="id"><a href="CDF.CSL.html#com">com</a></span> :=<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#ATOMIC">ATOMIC</a></span> (<span class="id"><a href="CDF.CSL.html#SET">SET</a></span> <span class="id">lck</span> 1).<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_swap">triple_swap</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">lck</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#sem_invariant">sem_invariant</a></span> <span class="id">lck</span> <span class="id">R</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#SWAP">SWAP</a></span> <span class="id">lck</span> 0 <span class="id">⦃</span> <span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="kwd">if</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.eqb">Z.eqb</a></span> <span class="id">v</span> 0 <span class="kwd">then</span> <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="kwd">else</span> <span class="id">R</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_atomic">triple_atomic</a></span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span>. <span class="id">unfold</span> <span class="id"><a href="CDF.CSL.html#sem_invariant">sem_invariant</a></span> <span class="kwd">at</span> 1. <br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_exists_pre">triple_exists_pre</a></span>; <span class="id">intros</span> <span class="id">v</span>. <br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_let">triple_let</a></span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;(<span class="id">Q</span> := <span class="kwd">fun</span> <span class="id">v'</span> =&gt; ((<span class="id">v'</span> = <span class="id">v</span>) //\\ <span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">lck</span> <span class="id">v</span>) ** (<span class="kwd">if</span> <span class="id">v</span> =? 0 <span class="kwd">then</span> <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="kwd">else</span> <span class="id">R</span>)).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_get">triple_get</a></span>. <br/>
&nbsp;&nbsp;<span class="id">cbn</span>. <span class="id">intros</span> <span class="id">v'</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#lift_pureconj">lift_pureconj</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_simple_conj_pre">triple_simple_conj_pre</a></span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">EQ</span>; <span class="id">subst</span> <span class="id">v'</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_seq">triple_seq</a></span> <span class="kwd">with</span> (<span class="id">Q</span> := <span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">lck</span> 0 ** (<span class="kwd">if</span> <span class="id">v</span> =? 0 <span class="kwd">then</span> <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="kwd">else</span> <span class="id">R</span>)).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_consequence_pre">triple_consequence_pre</a></span> <span class="kwd">with</span> (<span class="id"><a href="CDF.Separation.html#valid">valid</a></span> <span class="id">lck</span>).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_set">triple_set</a></span>.<br/>
&nbsp;&nbsp;<span class="id">red</span>; <span class="id">intros</span>. <span class="kwd">exists</span> <span class="id">v</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_pure">triple_pure</a></span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="CDF.CSL.html#sem_invariant">sem_invariant</a></span>. <span class="id">red</span>; <span class="id">intros</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_comm">sepconj_comm</a></span>, <span class="id"><a href="CDF.Separation.html#lift_aexists">lift_aexists</a></span>. <span class="kwd">exists</span> 0.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.eqb_refl">Z.eqb_refl</a></span>. <span class="id">rewrite</span> &lt;- (<span class="id"><a href="CDF.Separation.html#sepconj_comm">sepconj_comm</a></span> <span class="id"><a href="CDF.Separation.html#emp">emp</a></span>), <span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span>. <span class="id">assumption</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_acquire">triple_acquire</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">lck</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#sem_invariant">sem_invariant</a></span> <span class="id">lck</span> <span class="id">R</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#ACQUIRE">ACQUIRE</a></span> <span class="id">lck</span> <span class="id">⦃</span> <span class="kwd">fun</span> _ =&gt; <span class="id">R</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_consequence_post">triple_consequence_post</a></span> <span class="kwd">with</span> (<span class="id">Q'</span> := <span class="kwd">fun</span> <span class="id">v</span> =&gt; (<span class="id">v</span> &lt;&gt; 0) //\\ (<span class="kwd">if</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.eqb">Z.eqb</a></span> <span class="id">v</span> 0 <span class="kwd">then</span> <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="kwd">else</span> <span class="id">R</span>)).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_repeat">triple_repeat</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_swap">triple_swap</a></span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.eqb_refl">Z.eqb_refl</a></span>. <span class="id">red</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">v</span> <span class="id">h</span> [<span class="id">H1</span> <span class="id">H2</span>]. <span class="id">apply</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.eqb_neq">Z.eqb_neq</a></span> <span class="kwd">in</span> <span class="id">H1</span>. <span class="id">rewrite</span> <span class="id">H1</span> <span class="kwd">in</span> <span class="id">H2</span>. <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_release">triple_release</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">lck</span> <span class="id">R</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#precise">precise</a></span> <span class="id">R</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#sem_invariant">sem_invariant</a></span> <span class="id">lck</span> <span class="id">R</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">R</span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#RELEASE">RELEASE</a></span> <span class="id">lck</span> <span class="id">⦃</span> <span class="kwd">fun</span> _ =&gt; <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_atomic">triple_atomic</a></span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_comm">sepconj_comm</a></span>. <span class="id">unfold</span> <span class="id"><a href="CDF.CSL.html#sem_invariant">sem_invariant</a></span> <span class="kwd">at</span> 1. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#lift_aexists">lift_aexists</a></span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_exists_pre">triple_exists_pre</a></span>. <span class="id">intros</span> <span class="id">v</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_assoc">sepconj_assoc</a></span>. <br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_consequence_post">triple_consequence_post</a></span> <span class="kwd">with</span> (<span class="id">Q'</span> := <span class="kwd">fun</span> _ =&gt; <span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">lck</span> 1 ** (<span class="kwd">if</span> <span class="id">v</span> =? 0 <span class="kwd">then</span> <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="kwd">else</span> <span class="id">R</span>) ** <span class="id">R</span>).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span>. <br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_consequence_pre">triple_consequence_pre</a></span> <span class="kwd">with</span> (<span class="id"><a href="CDF.Separation.html#valid">valid</a></span> <span class="id">lck</span>). <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_set">triple_set</a></span>.<br/>
&nbsp;&nbsp;<span class="id">red</span>; <span class="id">intros</span>. <span class="kwd">exists</span> <span class="id">v</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> _. <span class="id">intros</span> <span class="id">h</span> <span class="id">P</span>.<br/>
&nbsp;&nbsp;<span class="id">assert</span> ((<span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">lck</span> 1 ** <span class="id">R</span>) <span class="id">h</span>).<br/>
&nbsp;&nbsp;{ <span class="id">eapply</span> <span class="id"><a href="CDF.Separation.html#sepconj_imp_r">sepconj_imp_r</a></span>; <span class="id">eauto</span>. <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">destruct</span> (<span class="id">v</span> =? 0).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span>. <span class="id">red</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#sepconj_self">sepconj_self</a></span>; <span class="id">auto</span>. }<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span>. <span class="kwd">exists</span> 1. <span class="id">simpl</span>. <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<h2> 3.2.  Critical regions </h2>
<br/>
<div class="doc">A critical region is a command that is run in mutual exclusion,
    while holding the associated lock. </div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="CRITREGION">CRITREGION</a></span> (<span class="id">lck</span>: <span class="id"><a href="CDF.Separation.html#addr">addr</a></span>) (<span class="id">c</span>: <span class="id"><a href="CDF.CSL.html#com">com</a></span>) :=<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#SEQ">SEQ</a></span> (<span class="id"><a href="CDF.CSL.html#ACQUIRE">ACQUIRE</a></span> <span class="id">lck</span>) (<span class="id"><a href="CDF.CSL.html#LET">LET</a></span> <span class="id">c</span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id"><a href="CDF.CSL.html#SEQ">SEQ</a></span> (<span class="id"><a href="CDF.CSL.html#RELEASE">RELEASE</a></span> <span class="id">lck</span>) (<span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> <span class="id">v</span>))).<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_critregion">triple_critregion</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">lck</span> <span class="id">R</span> <span class="id">c</span> <span class="id">P</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#precise">precise</a></span> <span class="id">R</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> ** <span class="id">R</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">Q</span> <span class="id">v</span> ** <span class="id">R</span> <span class="id">⦄</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#sem_invariant">sem_invariant</a></span> <span class="id">lck</span> <span class="id">R</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#CRITREGION">CRITREGION</a></span> <span class="id">lck</span> <span class="id">c</span> <span class="id">⦃</span> <span class="id">Q</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_seq">triple_seq</a></span> <span class="kwd">with</span> (<span class="id">Q</span> := <span class="id">R</span> ** <span class="id">P</span>).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- (<span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span> <span class="id">P</span>) <span class="kwd">at</span> 1. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_acquire">triple_acquire</a></span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_let">triple_let</a></span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_comm">sepconj_comm</a></span>. <span class="id">rewrite</span> &lt;- <span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span> <span class="kwd">at</span> 1. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame_invariant">triple_frame_invariant</a></span>. <span class="id">apply</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">simpl</span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_seq">triple_seq</a></span> <span class="kwd">with</span> (<span class="id">Q</span> := <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> ** <span class="id">Q</span> <span class="id">v</span>).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_comm">sepconj_comm</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_release">triple_release</a></span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_pure">triple_pure</a></span>. <span class="id">red</span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<h2> 3.3. Conditional critical regions </h2>
<br/>
<div class="doc">A conditional critical region (CCR), as introduced by
    Brinch-Hansen and Hoare, is a command <span class="bracket"><span class="id">c</span></span> that is run in mutual
    exclusion but only when a condition <span class="bracket"><span class="id">b</span></span> is true. </div>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="CCR">CCR</a></span> (<span class="id">lck</span>: <span class="id"><a href="CDF.Separation.html#addr">addr</a></span>) (<span class="id">b</span>: <span class="id"><a href="CDF.CSL.html#com">com</a></span>) (<span class="id">c</span>: <span class="id"><a href="CDF.CSL.html#com">com</a></span>) :=<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#REPEAT">REPEAT</a></span> (<span class="id"><a href="CDF.CSL.html#SEQ">SEQ</a></span> (<span class="id"><a href="CDF.CSL.html#ACQUIRE">ACQUIRE</a></span> <span class="id">lck</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="CDF.CSL.html#LET">LET</a></span> <span class="id">b</span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id"><a href="CDF.CSL.html#IFTHENELSE">IFTHENELSE</a></span> <span class="id">v</span> (<span class="id"><a href="CDF.CSL.html#SEQ">SEQ</a></span> <span class="id">c</span> (<span class="id"><a href="CDF.CSL.html#SEQ">SEQ</a></span> (<span class="id"><a href="CDF.CSL.html#RELEASE">RELEASE</a></span> <span class="id">lck</span>) (<span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> 1)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="CDF.CSL.html#SEQ">SEQ</a></span> (<span class="id"><a href="CDF.CSL.html#RELEASE">RELEASE</a></span> <span class="id">lck</span>) (<span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> 0))))).<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="triple_ccr">triple_ccr</a></span>:<br/>
&nbsp;&nbsp;<span class="kwd">forall</span> <span class="id">lck</span> <span class="id">R</span> <span class="id">b</span> <span class="id">c</span> <span class="id">B</span> <span class="id">P</span> <span class="id">Q</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#precise">precise</a></span> <span class="id">R</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> ** <span class="id">R</span> <span class="id">⦄</span> <span class="id">b</span> <span class="id">⦃</span> <span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="kwd">if</span> <span class="id">v</span> =? 0 <span class="kwd">then</span> <span class="id">P</span> ** <span class="id">R</span> <span class="kwd">else</span> <span class="id">B</span> <span class="id">⦄</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">B</span> <span class="id">⦄</span> <span class="id">c</span> <span class="id">⦃</span> <span class="kwd">fun</span> _ =&gt; <span class="id">Q</span> ** <span class="id">R</span> <span class="id">⦄</span> -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#sem_invariant">sem_invariant</a></span> <span class="id">lck</span> <span class="id">R</span> <span class="id">⊢</span> <span class="id">⦃</span> <span class="id">P</span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#CCR">CCR</a></span> <span class="id">lck</span> <span class="id">b</span> <span class="id">c</span> <span class="id">⦃</span> <span class="kwd">fun</span> _ =&gt; <span class="id">Q</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> (<span class="id">Qloop</span> := <span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="kwd">if</span> <span class="id">v</span> =? 0 <span class="kwd">then</span> <span class="id">P</span> <span class="kwd">else</span> <span class="id">Q</span>).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_consequence_post">triple_consequence_post</a></span> <span class="kwd">with</span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; (<span class="id">v</span> &lt;&gt; 0) //\\ <span class="id">Qloop</span> <span class="id">v</span>).<br/>
&nbsp;&nbsp;2: { <span class="id">intros</span> <span class="id">v</span> <span class="id">h</span> (<span class="id">U</span> &amp; <span class="id">V</span>). <span class="id">red</span> <span class="kwd">in</span> <span class="id">V</span>. <span class="id">apply</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.eqb_neq">Z.eqb_neq</a></span> <span class="kwd">in</span> <span class="id">U</span>. <span class="id">rewrite</span> <span class="id">U</span> <span class="kwd">in</span> <span class="id">V</span>. <span class="id">auto</span>. }<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_repeat">triple_repeat</a></span>.<br/>
&nbsp;&nbsp;2: { <span class="id">unfold</span> <span class="id">Qloop</span>. <span class="id">intros</span> <span class="id">v</span> <span class="id">U</span>. <span class="id">simpl</span> <span class="kwd">in</span> <span class="id">U</span>. <span class="id">auto</span>. }<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_seq">triple_seq</a></span> <span class="kwd">with</span> (<span class="id">Q</span> := <span class="id">R</span> ** <span class="id">P</span>).<br/>
&nbsp;&nbsp;{ <span class="id">rewrite</span> &lt;- (<span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span> <span class="id">P</span>) <span class="kwd">at</span> 1. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_acquire">triple_acquire</a></span>. }<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_comm">sepconj_comm</a></span> <span class="kwd">at</span> 1.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_let">triple_let</a></span>. <span class="id">rewrite</span> &lt;- <span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span> <span class="kwd">at</span> 1. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame_invariant">triple_frame_invariant</a></span>. <span class="id">eexact</span> <span class="id">H0</span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">v</span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_ifthenelse">triple_ifthenelse</a></span>.<br/>
- <span class="comment">(*&nbsp;B&nbsp;succeeded&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_seq">triple_seq</a></span>.<br/>
&nbsp;&nbsp;{ <span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_consequence_pre">triple_consequence_pre</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- <span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span> <span class="kwd">at</span> 1. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame_invariant">triple_frame_invariant</a></span>. <span class="id">eexact</span> <span class="id">H1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> <span class="id">h</span> (<span class="id">X</span> &amp; <span class="id">Y</span>). <span class="id">apply</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.eqb_neq">Z.eqb_neq</a></span> <span class="kwd">in</span> <span class="id">X</span>. <span class="id">rewrite</span> <span class="id">X</span> <span class="kwd">in</span> <span class="id">Y</span>. <span class="id">auto</span>. }<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_seq">triple_seq</a></span> <span class="kwd">with</span> (<span class="id">Q</span> := <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> ** <span class="id">Q</span>).<br/>
&nbsp;&nbsp;{ <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_comm">sepconj_comm</a></span> <span class="kwd">at</span> 1. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_release">triple_release</a></span>; <span class="id">auto</span>. }<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_pure">triple_pure</a></span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span>. <span class="id">unfold</span> <span class="id">Qloop</span>. <span class="id">cbn</span>. <span class="id">red</span>; <span class="id">auto</span>.<br/>
- <span class="comment">(*&nbsp;B&nbsp;failed&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_consequence_pre">triple_consequence_pre</a></span> <span class="kwd">with</span> (<span class="id">P</span> ** <span class="id">R</span>).<br/>
&nbsp;&nbsp;2: { <span class="id">intros</span> <span class="id">h</span> (<span class="id">X</span> &amp; <span class="id">Y</span>). <span class="id">subst</span> <span class="id">v</span>. <span class="id">auto</span>. }<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_seq">triple_seq</a></span> <span class="kwd">with</span> (<span class="id">Q</span> := <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> ** <span class="id">P</span>).<br/>
&nbsp;&nbsp;{ <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_comm">sepconj_comm</a></span> <span class="kwd">at</span> 1. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_release">triple_release</a></span>; <span class="id">auto</span>. }<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_pure">triple_pure</a></span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span>. <span class="id">unfold</span> <span class="id">Qloop</span>. <span class="id">cbn</span>. <span class="id">red</span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<h1> 4. The producer/consumer problem </h1>
<br/>
<div class="doc">4.1.  With a one-place buffer and binary semaphores </div>
<br/>
<span class="kwd">Module</span> <span class="id"><a name="ProdCons1">ProdCons1</a></span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="ProdCons1.PRODUCE">PRODUCE</a></span> (<span class="id">buff</span> <span class="id">free</span> <span class="id">busy</span>: <span class="id"><a href="CDF.Separation.html#addr">addr</a></span>) (<span class="id">data</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Numbers.BinNums.html#Z">Z</a></span>) : <span class="id"><a href="CDF.CSL.html#com">com</a></span> :=<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#SEQ">SEQ</a></span> (<span class="id"><a href="CDF.CSL.html#ACQUIRE">ACQUIRE</a></span> <span class="id">free</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="CDF.CSL.html#SEQ">SEQ</a></span> (<span class="id"><a href="CDF.CSL.html#SET">SET</a></span> <span class="id">buff</span> <span class="id">data</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="CDF.CSL.html#RELEASE">RELEASE</a></span> <span class="id">busy</span>)).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="ProdCons1.CONSUME">CONSUME</a></span> (<span class="id">buff</span> <span class="id">free</span> <span class="id">busy</span>: <span class="id"><a href="CDF.Separation.html#addr">addr</a></span>) : <span class="id"><a href="CDF.CSL.html#com">com</a></span> :=<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#SEQ">SEQ</a></span> (<span class="id"><a href="CDF.CSL.html#ACQUIRE">ACQUIRE</a></span> <span class="id">busy</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="CDF.CSL.html#LET">LET</a></span> (<span class="id"><a href="CDF.CSL.html#GET">GET</a></span> <span class="id">buff</span>) (<span class="kwd">fun</span> <span class="id">data</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="CDF.CSL.html#SEQ">SEQ</a></span> (<span class="id"><a href="CDF.CSL.html#RELEASE">RELEASE</a></span> <span class="id">free</span>) (<span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> <span class="id">data</span>)))).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="ProdCons1.buffer_invariant">buffer_invariant</a></span> (<span class="id">R</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Numbers.BinNums.html#Z">Z</a></span> -&gt; <span class="id"><a href="CDF.Separation.html#assertion">assertion</a></span>) (<span class="id">buff</span> <span class="id">free</span> <span class="id">busy</span>: <span class="id"><a href="CDF.Separation.html#addr">addr</a></span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#sem_invariant">sem_invariant</a></span> <span class="id">free</span> (<span class="id"><a href="CDF.Separation.html#valid">valid</a></span> <span class="id">buff</span>)<br/>
&nbsp;** <span class="id"><a href="CDF.CSL.html#sem_invariant">sem_invariant</a></span> <span class="id">busy</span> (<span class="id"><a href="CDF.Separation.html#aexists">aexists</a></span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">buff</span> <span class="id">v</span> ** <span class="id">R</span> <span class="id">v</span>)).<br/>
<br/>
<span class="kwd">Remark</span> <span class="id"><a name="ProdCons1.precise_buffer_invariant">precise_buffer_invariant</a></span>: <span class="kwd">forall</span> (<span class="id">R</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Numbers.BinNums.html#Z">Z</a></span> -&gt; <span class="id"><a href="CDF.Separation.html#assertion">assertion</a></span>) <span class="id">buff</span>,<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">v</span>, <span class="id"><a href="CDF.Separation.html#precise">precise</a></span> (<span class="id">R</span> <span class="id">v</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#precise">precise</a></span> (<span class="id"><a href="CDF.Separation.html#aexists">aexists</a></span> (<span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">buff</span> <span class="id">v</span> ** <span class="id">R</span> <span class="id">v</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#aexists_precise">aexists_precise</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#sepconj_param_precise">sepconj_param_precise</a></span>; <span class="id">auto</span>. <span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#contains_param_precise">contains_param_precise</a></span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="ProdCons1.triple_consume">triple_consume</a></span>: <span class="kwd">forall</span> <span class="id">R</span> <span class="id">buff</span> <span class="id">free</span> <span class="id">busy</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#ProdCons1.buffer_invariant">buffer_invariant</a></span> <span class="id">R</span> <span class="id">buff</span> <span class="id">free</span> <span class="id">busy</span> <span class="id">⊢</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">⦃</span> <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#ProdCons1.CONSUME">CONSUME</a></span> <span class="id">buff</span> <span class="id">free</span> <span class="id">busy</span> <span class="id">⦃</span> <span class="kwd">fun</span> <span class="id">v</span> =&gt; <span class="id">R</span> <span class="id">v</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_seq">triple_seq</a></span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="CDF.CSL.html#ProdCons1.buffer_invariant">buffer_invariant</a></span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_comm">sepconj_comm</a></span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame_invariant">triple_frame_invariant</a></span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_acquire">triple_acquire</a></span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_exists_pre">triple_exists_pre</a></span>. <span class="id">intros</span> <span class="id">v</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_let">triple_let</a></span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_get">triple_get</a></span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">v'</span>. <span class="id">cbn</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#lift_pureconj">lift_pureconj</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_simple_conj_pre">triple_simple_conj_pre</a></span>. <span class="id">intros</span> <span class="id">EQ</span>; <span class="id">subst</span> <span class="id">v'</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_seq">triple_seq</a></span> <span class="kwd">with</span> (<span class="id"><a href="CDF.Separation.html#emp">emp</a></span> ** <span class="id">R</span> <span class="id">v</span>).<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="CDF.CSL.html#ProdCons1.buffer_invariant">buffer_invariant</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame_invariant">triple_frame_invariant</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_consequence_pre">triple_consequence_pre</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_release">triple_release</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#valid_precise">valid_precise</a></span>.<br/>
&nbsp;&nbsp;<span class="id">red</span>; <span class="id">intros</span>; <span class="kwd">exists</span> <span class="id">v</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_pure">triple_pure</a></span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span>. <span class="id">red</span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="ProdCons1.triple_produce">triple_produce</a></span>: <span class="kwd">forall</span> (<span class="id">R</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Numbers.BinNums.html#Z">Z</a></span> -&gt; <span class="id"><a href="CDF.Separation.html#assertion">assertion</a></span>) <span class="id">buff</span> <span class="id">free</span> <span class="id">busy</span> <span class="id">data</span>,<br/>
&nbsp;&nbsp;(<span class="kwd">forall</span> <span class="id">v</span>, <span class="id"><a href="CDF.Separation.html#precise">precise</a></span> (<span class="id">R</span> <span class="id">v</span>)) -&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#ProdCons1.buffer_invariant">buffer_invariant</a></span> <span class="id">R</span> <span class="id">buff</span> <span class="id">free</span> <span class="id">busy</span> <span class="id">⊢</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">⦃</span> <span class="id">R</span> <span class="id">data</span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#ProdCons1.PRODUCE">PRODUCE</a></span> <span class="id">buff</span> <span class="id">free</span> <span class="id">busy</span> <span class="id">data</span> <span class="id">⦃</span> <span class="kwd">fun</span> _ =&gt; <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_seq">triple_seq</a></span> <span class="kwd">with</span> (<span class="id"><a href="CDF.Separation.html#valid">valid</a></span> <span class="id">buff</span> ** <span class="id">R</span> <span class="id">data</span>).<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="CDF.CSL.html#ProdCons1.buffer_invariant">buffer_invariant</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame_invariant">triple_frame_invariant</a></span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- (<span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span> (<span class="id">R</span> <span class="id">data</span>)) <span class="kwd">at</span> 1.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_acquire">triple_acquire</a></span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_seq">triple_seq</a></span> <span class="kwd">with</span> (<span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">buff</span> <span class="id">data</span> ** <span class="id">R</span> <span class="id">data</span>).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_set">triple_set</a></span>.<br/>
&nbsp;&nbsp;<span class="id">unfold</span> <span class="id"><a href="CDF.CSL.html#ProdCons1.buffer_invariant">buffer_invariant</a></span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_comm">sepconj_comm</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame_invariant">triple_frame_invariant</a></span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_consequence_pre">triple_consequence_pre</a></span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_release">triple_release</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#ProdCons1.precise_buffer_invariant">precise_buffer_invariant</a></span>. <span class="id">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id">red</span>; <span class="id">intros</span>. <span class="kwd">exists</span> <span class="id">data</span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">End</span> <span class="id"><a href="CDF.CSL.html#ProdCons1">ProdCons1</a></span>.<br/>
<br/>
<h2> 4.2. With an unbounded buffer implemented as a list </h2>
<br/>
<span class="kwd">Module</span> <span class="id"><a name="ProdCons2">ProdCons2</a></span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="ProdCons2.PRODUCE">PRODUCE</a></span> (<span class="id">buff</span>: <span class="id"><a href="CDF.Separation.html#addr">addr</a></span>) (<span class="id">data</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Numbers.BinNums.html#Z">Z</a></span>) : <span class="id"><a href="CDF.CSL.html#com">com</a></span> :=<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#LET">LET</a></span> (<span class="id"><a href="CDF.CSL.html#ALLOC">ALLOC</a></span> 2) (<span class="kwd">fun</span> <span class="id">a</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#SEQ">SEQ</a></span> (<span class="id"><a href="CDF.CSL.html#SET">SET</a></span> <span class="id">a</span> <span class="id">data</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="CDF.CSL.html#ATOMIC">ATOMIC</a></span> (<span class="id"><a href="CDF.CSL.html#LET">LET</a></span> (<span class="id"><a href="CDF.CSL.html#GET">GET</a></span> <span class="id">buff</span>) (<span class="kwd">fun</span> <span class="id">prev</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#SEQ">SEQ</a></span> (<span class="id"><a href="CDF.CSL.html#SET">SET</a></span> (<span class="id">a</span> + 1) <span class="id">prev</span>) (<span class="id"><a href="CDF.CSL.html#SET">SET</a></span> <span class="id">buff</span> <span class="id">a</span>))))).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="ProdCons2.POP">POP</a></span> (<span class="id">buff</span>: <span class="id"><a href="CDF.Separation.html#addr">addr</a></span>) : <span class="id"><a href="CDF.CSL.html#com">com</a></span> :=<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#REPEAT">REPEAT</a></span> (<span class="id"><a href="CDF.CSL.html#ATOMIC">ATOMIC</a></span> (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#LET">LET</a></span> (<span class="id"><a href="CDF.CSL.html#GET">GET</a></span> <span class="id">buff</span>) (<span class="kwd">fun</span> <span class="id">b</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#IFTHENELSE">IFTHENELSE</a></span> <span class="id">b</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="CDF.CSL.html#LET">LET</a></span> (<span class="id"><a href="CDF.CSL.html#GET">GET</a></span> (<span class="id">b</span> + 1)) (<span class="kwd">fun</span> <span class="id">next</span> =&gt; <span class="id"><a href="CDF.CSL.html#SEQ">SEQ</a></span> (<span class="id"><a href="CDF.CSL.html#SET">SET</a></span> <span class="id">buff</span> <span class="id">next</span>) (<span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> <span class="id">b</span>)))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> 0)))).<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="ProdCons2.CONSUME">CONSUME</a></span> (<span class="id">buff</span>: <span class="id"><a href="CDF.Separation.html#addr">addr</a></span>) : <span class="id"><a href="CDF.CSL.html#com">com</a></span> :=<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#LET">LET</a></span> (<span class="id"><a href="CDF.CSL.html#ProdCons2.POP">POP</a></span> <span class="id">buff</span>) (<span class="kwd">fun</span> <span class="id">b</span> =&gt;<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#LET">LET</a></span> (<span class="id"><a href="CDF.CSL.html#GET">GET</a></span> <span class="id">b</span>) (<span class="kwd">fun</span> <span class="id">data</span> =&gt;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#SEQ">SEQ</a></span> (<span class="id"><a href="CDF.CSL.html#FREE">FREE</a></span> <span class="id">b</span>) (<span class="id"><a href="CDF.CSL.html#SEQ">SEQ</a></span> (<span class="id"><a href="CDF.CSL.html#FREE">FREE</a></span> (<span class="id">b</span> + 1)) (<span class="id"><a href="CDF.CSL.html#PURE">PURE</a></span> <span class="id">data</span>)))).<br/>
<br/>
<span class="kwd">Fixpoint</span> <span class="id"><a name="ProdCons2.list_invariant">list_invariant</a></span> (<span class="id">R</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Numbers.BinNums.html#Z">Z</a></span> -&gt; <span class="id"><a href="CDF.Separation.html#assertion">assertion</a></span>) (<span class="id">l</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#list">list</a></span> <span class="id"><a href="https://coq.inria.fr/library/Coq.Numbers.BinNums.html#Z">Z</a></span>) (<span class="id">p</span>: <span class="id"><a href="CDF.Separation.html#addr">addr</a></span>) : <span class="id"><a href="CDF.Separation.html#assertion">assertion</a></span> :=<br/>
&nbsp;&nbsp;<span class="kwd">match</span> <span class="id">l</span> <span class="kwd">with</span><br/>
&nbsp;&nbsp;| <span class="id"><a href="https://coq.inria.fr/library/Coq.Init.Datatypes.html#nil">nil</a></span> =&gt; (<span class="id">p</span> = 0) //\\ <span class="id"><a href="CDF.Separation.html#emp">emp</a></span><br/>
&nbsp;&nbsp;| <span class="id">x</span> :: <span class="id">l</span> =&gt; (<span class="id">p</span> &lt;&gt; 0) //\\ <span class="id"><a href="CDF.Separation.html#aexists">aexists</a></span> (<span class="kwd">fun</span> <span class="id">q</span> =&gt; <span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">p</span> <span class="id">x</span> ** <span class="id"><a href="CDF.Separation.html#contains">contains</a></span> (<span class="id">p</span> + 1) <span class="id">q</span> ** <span class="id">R</span> <span class="id">x</span> ** <span class="id">list_invariant</span> <span class="id">R</span> <span class="id">l</span> <span class="id">q</span>)<br/>
&nbsp;&nbsp;<span class="kwd">end</span>.<br/>
<br/>
<span class="kwd">Definition</span> <span class="id"><a name="ProdCons2.buffer_invariant">buffer_invariant</a></span> (<span class="id">R</span>: <span class="id"><a href="https://coq.inria.fr/library/Coq.Numbers.BinNums.html#Z">Z</a></span> -&gt; <span class="id"><a href="CDF.Separation.html#assertion">assertion</a></span>) (<span class="id">buff</span>: <span class="id"><a href="CDF.Separation.html#addr">addr</a></span>) : <span class="id"><a href="CDF.Separation.html#assertion">assertion</a></span> :=<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.Separation.html#aexists">aexists</a></span> (<span class="kwd">fun</span> <span class="id">l</span> =&gt; <span class="id"><a href="CDF.Separation.html#aexists">aexists</a></span> (<span class="kwd">fun</span> <span class="id">p</span> =&gt; <span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">buff</span> <span class="id">p</span> ** <span class="id"><a href="CDF.CSL.html#ProdCons2.list_invariant">list_invariant</a></span> <span class="id">R</span> <span class="id">l</span> <span class="id">p</span>)).<br/>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="ProdCons2.triple_produce">triple_produce</a></span>: <span class="kwd">forall</span> <span class="id">R</span> <span class="id">buff</span> <span class="id">data</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#ProdCons2.buffer_invariant">buffer_invariant</a></span> <span class="id">R</span> <span class="id">buff</span> <span class="id">⊢</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">⦃</span> <span class="id">R</span> <span class="id">data</span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#ProdCons2.PRODUCE">PRODUCE</a></span> <span class="id">buff</span> <span class="id">data</span> <span class="id">⦃</span> <span class="kwd">fun</span> _ =&gt; <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_let">triple_let</a></span>.<br/>
&nbsp;&nbsp;{ <span class="id">rewrite</span> &lt;- (<span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span> (<span class="id">R</span> <span class="id">data</span>)). <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_alloc">triple_alloc</a></span>. }<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">a</span>; <span class="id">cbn</span>. <br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#lift_pureconj">lift_pureconj</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_simple_conj_pre">triple_simple_conj_pre</a></span>; <span class="id">intros</span> <span class="id">NOT0</span>. <br/>
&nbsp;&nbsp;<span class="id">rewrite</span> ! <span class="id"><a href="CDF.Separation.html#sepconj_assoc">sepconj_assoc</a></span>, <span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_seq">triple_seq</a></span> <span class="kwd">with</span> (<span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">a</span> <span class="id">data</span> ** <span class="id"><a href="CDF.Separation.html#valid">valid</a></span> (<span class="id">a</span> + 1) ** <span class="id">R</span> <span class="id">data</span>).<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_set">triple_set</a></span>. }<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_atomic">triple_atomic</a></span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_comm">sepconj_comm</a></span>. <span class="id">unfold</span> <span class="id"><a href="CDF.CSL.html#ProdCons2.buffer_invariant">buffer_invariant</a></span>. <br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#lift_aexists">lift_aexists</a></span>; <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_exists_pre">triple_exists_pre</a></span>; <span class="id">intros</span> <span class="id">l</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#lift_aexists">lift_aexists</a></span>; <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_exists_pre">triple_exists_pre</a></span>; <span class="id">intros</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_assoc">sepconj_assoc</a></span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_let">triple_let</a></span>.<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_get">triple_get</a></span>. }<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">p'</span>; <span class="id">cbn</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#lift_pureconj">lift_pureconj</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_simple_conj_pre">triple_simple_conj_pre</a></span>; <span class="id">intros</span> <span class="id">EQ</span>; <span class="id">subst</span> <span class="id">p'</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_seq">triple_seq</a></span>.<br/>
&nbsp;&nbsp;{ <span class="id">rewrite</span> (<span class="id"><a href="CDF.Separation.html#sepconj_pick3">sepconj_pick3</a></span> (<span class="id"><a href="CDF.Separation.html#valid">valid</a></span> (<span class="id">a</span> + 1))). <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_pick2">sepconj_pick2</a></span>. <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span> <span class="kwd">with</span> (<span class="id">Q</span> := <span class="kwd">fun</span> _ =&gt; <span class="id"><a href="CDF.Separation.html#contains">contains</a></span>  (<span class="id">a</span> + 1) <span class="id">p</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_set">triple_set</a></span>. }<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_pick2">sepconj_pick2</a></span>. <span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_consequence_post">triple_consequence_post</a></span>.<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span>. <span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_consequence_pre">triple_consequence_pre</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_set">triple_set</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> <span class="id">h</span> <span class="id">A</span>; <span class="kwd">exists</span> <span class="id">p</span>; <span class="id">auto</span>. }<br/>
&nbsp;&nbsp;<span class="id">cbn</span>. <span class="id">intros</span> _. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span>. <br/>
&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- (<span class="id"><a href="CDF.Separation.html#sepconj_swap3">sepconj_swap3</a></span> (<span class="id"><a href="CDF.CSL.html#ProdCons2.list_invariant">list_invariant</a></span> <span class="id">R</span> <span class="id">l</span> <span class="id">p</span>)).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="CDF.Separation.html#sepconj_pick2">sepconj_pick2</a></span> (<span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">a</span> <span class="id">data</span>)). <br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">h</span> <span class="id">A</span>. <span class="kwd">exists</span> (<span class="id">data</span> :: <span class="id">l</span>), <span class="id">a</span>.<br/>
&nbsp;&nbsp;<span class="id">revert</span> <span class="id">h</span> <span class="id">A</span>. <span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#sepconj_imp_r">sepconj_imp_r</a></span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">h</span> <span class="id">A</span>. <span class="id">cbn</span>. <span class="id">split</span>; <span class="id">auto</span>. <span class="kwd">exists</span> <span class="id">p</span>; <span class="id">exact</span> <span class="id">A</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="ProdCons2.triple_pop">triple_pop</a></span>: <span class="kwd">forall</span> <span class="id">R</span> <span class="id">buff</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#ProdCons2.buffer_invariant">buffer_invariant</a></span> <span class="id">R</span> <span class="id">buff</span> <span class="id">⊢</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">⦃</span> <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#ProdCons2.POP">POP</a></span> <span class="id">buff</span> <span class="id">⦃</span> <span class="kwd">fun</span> <span class="id">p</span> =&gt; <span class="id"><a href="CDF.Separation.html#aexists">aexists</a></span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">p</span> <span class="id">x</span> ** <span class="id"><a href="CDF.Separation.html#valid">valid</a></span> (<span class="id">p</span> + 1) ** <span class="id">R</span> <span class="id">x</span>) <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>.<br/>
&nbsp;&nbsp;<span class="id">set</span> (<span class="id">Qloop</span> := <span class="kwd">fun</span> <span class="id">p</span> =&gt; <span class="kwd">if</span> <span class="id">p</span> =? 0 <span class="kwd">then</span> <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="kwd">else</span> <span class="id"><a href="CDF.Separation.html#aexists">aexists</a></span> (<span class="kwd">fun</span> <span class="id">x</span> =&gt; <span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">p</span> <span class="id">x</span> ** <span class="id"><a href="CDF.Separation.html#valid">valid</a></span> (<span class="id">p</span> + 1) ** <span class="id">R</span> <span class="id">x</span>)).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_consequence_post">triple_consequence_post</a></span> <span class="kwd">with</span> (<span class="kwd">fun</span> <span class="id">p</span> =&gt; (<span class="id">p</span> &lt;&gt; 0) //\\ <span class="id">Qloop</span> <span class="id">p</span>).<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_repeat">triple_repeat</a></span>.<br/>
- <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_atomic">triple_atomic</a></span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_exists_pre">triple_exists_pre</a></span>; <span class="id">intros</span> <span class="id">l</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_exists_pre">triple_exists_pre</a></span>; <span class="id">intros</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_let">triple_let</a></span>.<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_get">triple_get</a></span>. }<br/>
&nbsp;&nbsp;<span class="id">cbn</span>. <span class="id">intros</span> <span class="id">p'</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#lift_pureconj">lift_pureconj</a></span>; <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_simple_conj_pre">triple_simple_conj_pre</a></span>; <span class="id">intros</span> <span class="id">E</span>; <span class="id">subst</span> <span class="id">p'</span>.<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_ifthenelse">triple_ifthenelse</a></span>.<br/>
&nbsp;&nbsp;+ <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_simple_conj_pre">triple_simple_conj_pre</a></span>; <span class="id">intros</span> <span class="id">NOTZERO</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_comm">sepconj_comm</a></span>. <span class="id">destruct</span> <span class="id">l</span> <span class="kwd">as</span> [ | <span class="id">x</span> <span class="id">l</span>]; <span class="id">cbn</span>; <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#lift_pureconj">lift_pureconj</a></span>; <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_simple_conj_pre">triple_simple_conj_pre</a></span>; <span class="id">intro</span>; <span class="id">try</span> <span class="id">lia</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#lift_aexists">lift_aexists</a></span>; <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_exists_pre">triple_exists_pre</a></span>; <span class="id">intros</span> <span class="id">t</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_let">triple_let</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">rewrite</span> ! <span class="id"><a href="CDF.Separation.html#sepconj_assoc">sepconj_assoc</a></span>, <span class="id"><a href="CDF.Separation.html#sepconj_pick2">sepconj_pick2</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_get">triple_get</a></span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> <span class="id">t'</span>; <span class="id">cbn</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#lift_pureconj">lift_pureconj</a></span>; <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_simple_conj_pre">triple_simple_conj_pre</a></span>; <span class="id">intros</span> <span class="id">E</span>; <span class="id">subst</span> <span class="id">t'</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- ! <span class="id"><a href="CDF.Separation.html#sepconj_assoc">sepconj_assoc</a></span>, <span class="id"><a href="CDF.Separation.html#sepconj_comm">sepconj_comm</a></span>, ! <span class="id"><a href="CDF.Separation.html#sepconj_assoc">sepconj_assoc</a></span>.  <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_seq">triple_seq</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span> <span class="kwd">with</span> (<span class="id">Q</span> := <span class="kwd">fun</span> _ =&gt; <span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">buff</span> <span class="id">t</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_consequence_pre">triple_consequence_pre</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_set">triple_set</a></span>. <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> <span class="id">h</span> <span class="id">A</span>; <span class="kwd">exists</span> <span class="id">p</span>; <span class="id">auto</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_pure">triple_pure</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">unfold</span> <span class="id">Qloop</span>. <span class="id">apply</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.eqb_neq">Z.eqb_neq</a></span> <span class="kwd">in</span> <span class="id">NOTZERO</span>; <span class="id">rewrite</span> <span class="id">NOTZERO</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id"><a href="CDF.Separation.html#sepconj_pick2">sepconj_pick2</a></span> (<span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">p</span> <span class="id">x</span>)). <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- (<span class="id"><a href="CDF.Separation.html#sepconj_pick3">sepconj_pick3</a></span> (<span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">buff</span> <span class="id">t</span>)). <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> &lt;- (<span class="id"><a href="CDF.Separation.html#sepconj_pick2">sepconj_pick2</a></span> (<span class="id"><a href="CDF.Separation.html#contains">contains</a></span> <span class="id">buff</span> <span class="id">t</span>)).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> <span class="id">h</span> <span class="id">A</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#lift_aexists">lift_aexists</a></span>. <span class="kwd">exists</span> <span class="id">x</span>. <span class="id">rewrite</span> ! <span class="id"><a href="CDF.Separation.html#sepconj_assoc">sepconj_assoc</a></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.Separation.html#sepconj_imp_r">sepconj_imp_r</a></span>; <span class="id">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> <span class="id">h'</span> <span class="id">B</span>. <span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#sepconj_imp_l">sepconj_imp_l</a></span> <span class="kwd">with</span> (<span class="id">P</span> := <span class="id"><a href="CDF.Separation.html#contains">contains</a></span> (<span class="id">p</span> + 1) <span class="id">t</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> <span class="id">h''</span> <span class="id">C</span>. <span class="kwd">exists</span> <span class="id">t</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">revert</span> <span class="id">h'</span> <span class="id">B</span>. <span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#sepconj_imp_r">sepconj_imp_r</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.Separation.html#sepconj_imp_r">sepconj_imp_r</a></span>. <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">intros</span> <span class="id">h'''</span> <span class="id">D</span>. <span class="id">red</span>. <span class="kwd">exists</span> <span class="id">l</span>; <span class="kwd">exists</span> <span class="id">t</span>; <span class="id">auto</span>.<br/>
&nbsp;&nbsp;+ <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_simple_conj_pre">triple_simple_conj_pre</a></span>; <span class="id">intros</span> <span class="id">ZERO</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_pure">triple_pure</a></span>. <span class="id">unfold</span> <span class="id">Qloop</span>; <span class="id">cbn</span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span>. <span class="id">intros</span> <span class="id">h</span> <span class="id">A</span>; <span class="kwd">exists</span> <span class="id">l</span>, <span class="id">p</span>; <span class="id">auto</span>.<br/>
- <span class="id">unfold</span> <span class="id">Qloop</span>; <span class="id">cbn</span>. <span class="id">red</span>; <span class="id">auto</span>.<br/>
- <span class="id">unfold</span> <span class="id">Qloop</span>. <span class="id">intros</span> <span class="id">v</span> <span class="id">h</span> [<span class="id">A</span> <span class="id">B</span>]. <span class="id">apply</span> <span class="id"><a href="https://coq.inria.fr/library/Coq.ZArith.BinInt.html#Z.eqb_neq">Z.eqb_neq</a></span> <span class="kwd">in</span> <span class="id">A</span>. <span class="id">rewrite</span> <span class="id">A</span> <span class="kwd">in</span> <span class="id">B</span>. <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">Lemma</span> <span class="id"><a name="ProdCons2.triple_consume">triple_consume</a></span>: <span class="kwd">forall</span> <span class="id">R</span> <span class="id">buff</span>,<br/>
&nbsp;&nbsp;<span class="id"><a href="CDF.CSL.html#ProdCons2.buffer_invariant">buffer_invariant</a></span> <span class="id">R</span> <span class="id">buff</span> <span class="id">⊢</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">⦃</span> <span class="id"><a href="CDF.Separation.html#emp">emp</a></span> <span class="id">⦄</span> <span class="id"><a href="CDF.CSL.html#ProdCons2.CONSUME">CONSUME</a></span> <span class="id">buff</span> <span class="id">⦃</span> <span class="kwd">fun</span> <span class="id">data</span> =&gt; <span class="id">R</span> <span class="id">data</span> <span class="id">⦄</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
&nbsp;&nbsp;<span class="id">intros</span>. <span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_let">triple_let</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#ProdCons2.triple_pop">triple_pop</a></span>.<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">b</span>. <span class="id">cbn</span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_exists_pre">triple_exists_pre</a></span>; <span class="id">intros</span> <span class="id">p</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_let">triple_let</a></span>.<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_get">triple_get</a></span>. }<br/>
&nbsp;&nbsp;<span class="id">intros</span> <span class="id">p'</span>; <span class="id">cbn</span>; <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#lift_pureconj">lift_pureconj</a></span>; <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_simple_conj_pre">triple_simple_conj_pre</a></span>; <span class="id">intros</span> <span class="id">E</span>; <span class="id">subst</span> <span class="id">p'</span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_seq">triple_seq</a></span>.<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span> <span class="kwd">with</span> (<span class="id">Q</span> := <span class="kwd">fun</span> _ =&gt; <span class="id"><a href="CDF.Separation.html#emp">emp</a></span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_consequence_pre">triple_consequence_pre</a></span>. <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_free">triple_free</a></span>. <span class="id">intros</span> <span class="id">h</span> <span class="id">A</span>; <span class="kwd">exists</span> <span class="id">p</span>; <span class="id">auto</span>. }<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span>.<br/>
&nbsp;&nbsp;<span class="id">eapply</span> <span class="id"><a href="CDF.CSL.html#triple_seq">triple_seq</a></span>.<br/>
&nbsp;&nbsp;{ <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_frame">triple_frame</a></span> <span class="kwd">with</span> (<span class="id">Q</span> := <span class="kwd">fun</span> _ =&gt; <span class="id"><a href="CDF.Separation.html#emp">emp</a></span>). <span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_free">triple_free</a></span>. }<br/>
&nbsp;&nbsp;<span class="id">apply</span> <span class="id"><a href="CDF.CSL.html#triple_pure">triple_pure</a></span>. <span class="id">rewrite</span> <span class="id"><a href="CDF.Separation.html#sepconj_emp">sepconj_emp</a></span>. <span class="id">red</span>; <span class="id">auto</span>.<br/>
Qed.</div></details>
<br/>
<span class="kwd">End</span> <span class="id"><a href="CDF.CSL.html#ProdCons2">ProdCons2</a></span>.<br/>
<br/>

</div>
<div class="footer"><hr/>Generated by <a href="https://github.com/xavierleroy/coq2html/">coq2html</a></div>
</body>
</html>
